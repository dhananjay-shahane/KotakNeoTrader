function ETFSignalsManager() {
            this.positions = [];
            this.liveDataInterval = null;
            this.autoRefreshInterval = 10000; // 10 seconds
            this.searchTimeout = null;
            this.init();
        }

        ETFSignalsManager.prototype.init = function() {
            this.setupEventListeners();
            this.loadPositions();
            this.startAutoRefresh();
            this.initLiveDataConnection();
        };

        ETFSignalsManager.prototype.setupEventListeners = function() {
            var self = this;

            // Add deal button
            document.getElementById('addDealBtn').addEventListener('click', function() {
                self.showAddDealModal();
            });

            // Save position button
            document.getElementById('savePositionBtn').addEventListener('click', function() {
                self.savePosition();
            });

            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', function() {
                self.loadPositions();
            });

            // Auto refresh interval change
            document.getElementById('autoRefreshInterval').addEventListener('change', function(e) {
                self.autoRefreshInterval = parseInt(e.target.value) * 1000;
                self.startAutoRefresh();
            });

            // ETF symbol search
            document.getElementById('etfSymbol').addEventListener('input', function(e) {
                clearTimeout(self.searchTimeout);
                self.searchTimeout = setTimeout(function() {
                    self.searchETFSymbols(e.target.value);
                }, 300);
            });

            // Position filters
            document.getElementById('positionFilter').addEventListener('change', function() {
                self.filterPositions();
            });

            document.getElementById('statusFilter').addEventListener('change', function() {
                self.filterPositions();
            });

            // Auto refresh toggle
            document.getElementById('autoRefreshToggle').addEventListener('change', function(e) {
                if (e.target.checked) {
                    self.startAutoRefresh();
                } else {
                    self.stopAutoRefresh();
                }
            });

            // Export buttons
            document.getElementById('exportCsvBtn').addEventListener('click', function() {
                self.exportToCSV();
            });

            document.getElementById('exportPdfBtn').addEventListener('click', function() {
                self.exportToPDF();
            });
        };

        ETFSignalsManager.prototype.loadPositions = function() {
            var self = this;
            this.showLoading(true);

            fetch('/api/etf/signals')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (data.success) {
                        self.positions = data.signals || [];
                        self.renderPositionsTable();
                        self.updateSummaryCards(data.portfolio || {});
                        self.updateVisibleCount();
                    } else {
                        self.showAlert('Error loading positions: ' + (data.message || 'Unknown error'), 'error');
                    }
                })
                .catch(function(error) {
                    console.error('Error:', error);
                    self.showAlert('Error loading positions: ' + error.message, 'error');
                })
                .finally(function() {
                    self.showLoading(false);
                });
        };

        ETFSignalsManager.prototype.showLoading = function(show) {
            var loadingEl = document.getElementById('loadingSpinner');
            if (loadingEl) {
                loadingEl.style.display = show ? 'flex' : 'none';
            }
        };

        ETFSignalsManager.prototype.renderPositionsTable = function() {
            var tbody = document.querySelector('#etfSignalsTable tbody');
            if (!tbody) return;

            if (!this.positions || this.positions.length === 0) {
                tbody.innerHTML = 
                    '<tr>' +
                        '<td colspan="11" class="text-center text-muted py-4">' +
                            '<i class="fas fa-chart-line fa-3x mb-3 d-block"></i>' +
                            'No ETF positions found. Add your first position to get started.' +
                        '</td>' +
                    '</tr>';
                return;
            }

            var rows = [];
            for (var i = 0; i < this.positions.length; i++) {
                var position = this.positions[i];
                var pnlClass = position.pl >= 0 ? 'text-success' : 'text-danger';
                var pnlIcon = position.pl >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                var statusClass = position.status === 'ACTIVE' ? 'success' : 'secondary';

                rows.push(
                    '<tr class="table-row-hover">' +
                        '<td class="fw-bold text-primary">' + (position.etf || position.symbol || '-') + '</td>' +
                        '<td>' + (position.date || new Date().toLocaleDateString()) + '</td>' +
                        '<td>' +
                            '<span class="badge bg-' + (position.pos === 'LONG' || position.pos === 1 ? 'success' : 'danger') + '">' +
                                (position.pos === 'LONG' || position.pos === 1 ? 'LONG' : 'SHORT') +
                            '</span>' +
                        '</td>' +
                        '<td class="text-end">' + (position.qty || 0) + '</td>' +
                        '<td class="text-end">₹' + parseFloat(position.ep || 0).toFixed(2) + '</td>' +
                        '<td class="text-end">₹' + parseFloat(position.cmp || position.ep || 0).toFixed(2) + '</td>' +
                        '<td class="text-end ' + pnlClass + '">' +
                            '<i class="fas ' + pnlIcon + ' me-1"></i>' +
                            '₹' + parseFloat(position.pl || 0).toFixed(2) +
                        '</td>' +
                        '<td class="text-end ' + pnlClass + '">' +
                            parseFloat(position.chg || 0).toFixed(2) + '%' +
                        '</td>' +
                        '<td class="text-end">₹' + parseFloat(position.inv || 0).toFixed(2) + '</td>' +
                        '<td class="text-end">₹' + parseFloat(position.tp || 0).toFixed(2) + '</td>' +
                        '<td>' +
                            '<span class="badge bg-' + statusClass + '">' + (position.status || 'ACTIVE') + '</span>' +
                        '</td>' +
                    '</tr>'
                );
            }
            tbody.innerHTML = rows.join('');
        };

        ETFSignalsManager.prototype.updateSummaryCards = function(portfolio) {
            // Update portfolio summary cards
            var totalPositions = document.getElementById('totalPositions');
            var totalInvestment = document.getElementById('totalInvestment');
            var totalPnL = document.getElementById('totalPnL');
            var totalReturn = document.getElementById('totalReturn');

            if (totalPositions) totalPositions.textContent = portfolio.total_positions || 0;
            if (totalInvestment) totalInvestment.textContent = '₹' + (portfolio.total_investment || 0).toFixed(2);
            if (totalPnL) {
                var pnl = portfolio.total_pnl || 0;
                var pnlEl = document.getElementById('totalPnL');
                if (pnlEl) {
                    pnlEl.textContent = '₹' + pnl.toFixed(2);
                    pnlEl.className = pnl >= 0 ? 'text-success' : 'text-danger';
                }
            }
            if (totalReturn) {
                var returnPct = portfolio.return_percent || 0;
                var returnEl = document.getElementById('totalReturn');
                if (returnEl) {
                    returnEl.textContent = returnPct.toFixed(2) + '%';
                    returnEl.className = returnPct >= 0 ? 'text-success' : 'text-danger';
                }
            }
        };

        ETFSignalsManager.prototype.updateVisibleCount = function() {
            var visibleRows = document.querySelectorAll('#etfSignalsTable tbody tr:not([style*="display: none"])');
            var countEl = document.getElementById('visibleSignalsCount');
            if (countEl) {
                countEl.textContent = visibleRows.length;
            }
        };

        ETFSignalsManager.prototype.startAutoRefresh = function() {
            var self = this;
            this.stopAutoRefresh();
            if (this.autoRefreshInterval > 0) {
                this.liveDataInterval = setInterval(function() {
                    self.loadPositions();
                }, this.autoRefreshInterval);
            }
        };

        ETFSignalsManager.prototype.stopAutoRefresh = function() {
            if (this.liveDataInterval) {
                clearInterval(this.liveDataInterval);
                this.liveDataInterval = null;
            }
        };

        ETFSignalsManager.prototype.initLiveDataConnection = function() {
            // Initialize WebSocket or SSE connection for live updates if needed
            console.log('Live data connection initialized');
        };

        ETFSignalsManager.prototype.filterPositions = function() {
            var positionFilter = document.getElementById('positionFilter').value;
            var statusFilter = document.getElementById('statusFilter').value;

            var rows = document.querySelectorAll('#etfSignalsTable tbody tr');

            for (var i = 0; i < rows.length; i++) {
                var row = rows[i];
                var cells = row.querySelectorAll('td');
                if (cells.length < 3) continue;

                var positionType = cells[2].textContent.trim();
                var status = cells[10].textContent.trim();

                var showRow = true;

                if (positionFilter !== 'all' && positionType.toLowerCase().indexOf(positionFilter.toLowerCase()) === -1) {
                    showRow = false;
                }

                if (statusFilter !== 'all' && status.toLowerCase().indexOf(statusFilter.toLowerCase()) === -1) {
                    showRow = false;
                }

                row.style.display = showRow ? '' : 'none';
            }

            this.updateVisibleCount();
        };

        ETFSignalsManager.prototype.showAddDealModal = function() {
            var modal = new bootstrap.Modal(document.getElementById('addPositionModal'));
            modal.show();
        };

        ETFSignalsManager.prototype.savePosition = function() {
            var self = this;
            var formData = {
                etf_symbol: document.getElementById('etfSymbol').value,
                quantity: parseInt(document.getElementById('quantity').value),
                entry_price: parseFloat(document.getElementById('entryPrice').value),
                target_price: parseFloat(document.getElementById('targetPrice').value),
                position_type: document.getElementById('positionType').value,
                notes: document.getElementById('notes').value
            };

            fetch('/api/etf/signals', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success) {
                    self.showAlert('Position added successfully!', 'success');
                    self.loadPositions();
                    bootstrap.Modal.getInstance(document.getElementById('addPositionModal')).hide();
                    document.getElementById('addPositionForm').reset();
                } else {
                    self.showAlert('Error adding position: ' + (data.message || 'Unknown error'), 'error');
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                self.showAlert('Error adding position: ' + error.message, 'error');
            });
        };

        ETFSignalsManager.prototype.searchETFSymbols = function(query) {
            // Implement ETF symbol search if needed
            console.log('Searching ETF symbols:', query);
        };

        ETFSignalsManager.prototype.exportToCSV = function() {
            if (!this.positions || this.positions.length === 0) {
                this.showAlert('No data to export', 'warning');
                return;
            }

            var csv = this.convertToCSV(this.positions);
            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            var url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'etf_positions_' + new Date().toISOString().split('T')[0] + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        ETFSignalsManager.prototype.exportToPDF = function() {
            this.showAlert('PDF export feature coming soon!', 'info');
        };

        ETFSignalsManager.prototype.convertToCSV = function(data) {
            var headers = ['ETF Symbol', 'Date', 'Position', 'Quantity', 'Entry Price', 'Current Price', 'P&L', 'Change %', 'Investment', 'Target Price', 'Status'];
            var csvContent = [headers.join(',')];

            for (var i = 0; i < data.length; i++) {
                var row = data[i];
                var csvRow = [
                    row.etf || row.symbol || '',
                    row.date || '',
                    row.pos === 'LONG' || row.pos === 1 ? 'LONG' : 'SHORT',
                    row.qty || 0,
                    row.ep || 0,
                    row.cmp || row.ep || 0,
                    row.pl || 0,
                    row.chg || 0,
                    row.inv || 0,
                    row.tp || 0,
                    row.status || 'ACTIVE'
                ].join(',');
                csvContent.push(csvRow);
            }

            return csvContent.join('\n');
        };

        ETFSignalsManager.prototype.showAlert = function(message, type) {
            // Create a simple alert
            var alertClass = type === 'success' ? 'alert-success' : 
                           type === 'error' ? 'alert-danger' : 
                           type === 'warning' ? 'alert-warning' : 'alert-info';

            var alertHtml = 
                '<div class="alert ' + alertClass + ' alert-dismissible fade show position-fixed" ' +
                     'style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">' +
                    message +
                    '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                '</div>';

            document.body.insertAdjacentHTML('beforeend', alertHtml);

            // Auto remove after 5 seconds
            setTimeout(function() {
                var alert = document.querySelector('.alert:last-of-type');
                if (alert) {
                    bootstrap.Alert.getOrCreateInstance(alert).close();
                }
            }, 5000);
        };

// Initialize the ETF Signals Manager when page loads
        document.addEventListener('DOMContentLoaded', function() {
            window.etfSignalsManager = new ETFSignalsManager();
        });

        // Ensure DOM is fully loaded before initialization
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                if (!window.etfSignalsManager) {
                    window.etfSignalsManager = new ETFSignalsManager();
                }
            });
        } else {
            // DOM is already loaded
            if (!window.etfSignalsManager) {
                window.etfSignalsManager = new ETFSignalsManager();
            }
        }
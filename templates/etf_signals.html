{% extends "base.html" %}

{% block title %}Admin Trading Signals - Kotak Neo Trading{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

<style>
    .portfolio-metric {
        text-align: center;
        padding: 1rem;
    }

    .portfolio-summary {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
    }

    .summary-card {
        background: var(--dark-bg);
        border-radius: 6px;
        padding: 10px;
        text-align: center;
        border: 1px solid var(--border-color);
    }

    .live-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
    }

    .live-indicator.connected {
        background: var(--success-color);
        animation: pulse 2s infinite;
    }

    .live-indicator.disconnected {
        background: var(--danger-color);
    }

    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .dataTables_wrapper .dataTables_length,
    .dataTables_wrapper .dataTables_filter,
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
        color: var(--text-primary);
    }

    .dataTables_wrapper .dataTables_filter input {
        background-color: var(--dark-bg);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
    }

    .dataTables_wrapper .dataTables_length select {
        background-color: var(--dark-bg);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
    }

    .profit { color: var(--success-color); }
    .loss { color: var(--danger-color); }
    .neutral { color: var(--warning-color); }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">Admin Trading Signals</h1>
        <p class="text-muted mb-0">Real-time admin signals tracking and analysis</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-light" onclick="refreshSignals()" id="refreshBtn">
            <i class="fas fa-sync-alt me-1"></i>Refresh
        </button>
        <span class="badge bg-success me-2" id="liveIndicator">
            <span class="live-indicator connected"></span>Live Data
        </span>
        <a href="{{ url_for('admin_signals') }}" class="btn btn-primary">
            <i class="fas fa-user-shield me-1"></i>Admin Panel
        </a>
    </div>
</div>

<!-- Portfolio Summary -->
<div class="row mb-4">
    <div class="col-12">
        <div class="portfolio-summary">
            <h5 class="mb-3">
                <i class="fas fa-chart-pie me-2 text-primary"></i>Portfolio Summary
            </h5>
            <div class="row" id="portfolioSummary">
                <div class="col-md-2 mb-3">
                    <div class="summary-card">
                        <div class="text-muted small">Total Signals</div>
                        <div class="h5 mb-0" id="totalPositions">0</div>
                    </div>
                </div>
                <div class="col-md-2 mb-3">
                    <div class="summary-card">
                        <div class="text-muted small">Investment</div>
                        <div class="h5 mb-0" id="totalInvestment">₹0.00</div>
                    </div>
                </div>
                <div class="col-md-2 mb-3">
                    <div class="summary-card">
                        <div class="text-muted small">Current Value</div>
                        <div class="h5 mb-0" id="currentValue">₹0.00</div>
                    </div>
                </div>
                <div class="col-md-2 mb-3">
                    <div class="summary-card">
                        <div class="text-muted small">Total P&L</div>
                        <div class="h5 mb-0" id="totalPnl">₹0.00</div>
                    </div>
                </div>
                <div class="col-md-2 mb-3">
                    <div class="summary-card">
                        <div class="text-muted small">Return %</div>
                        <div class="h5 mb-0" id="returnPercent">0.00%</div>
                    </div>
                </div>
                <div class="col-md-2 mb-3">
                    <div class="summary-card">
                        <div class="text-muted small">Active/Total</div>
                        <div class="h5 mb-0"><span id="activePositions">0</span>/<span id="totalSignals">0</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Trading Signals DataTable -->
<div class="card bg-secondary border-0 shadow-lg">
    <div class="card-header bg-dark border-0 d-flex justify-content-between align-items-center">
        <h5 class="mb-0 text-light">
            <i class="fas fa-signal me-2 text-primary"></i>Admin Trading Signals
            <span class="badge bg-primary ms-2" id="signalsCount">0</span>
        </h5>
        <div class="d-flex gap-2">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
                <label class="form-check-label text-light" for="autoRefreshToggle">
                    Auto Refresh
                </label>
            </div>
            <button class="btn btn-sm btn-outline-light" onclick="exportSignals()">
                <i class="fas fa-download me-1"></i>Export
            </button>
        </div>
    </div>

    <div class="card-body">
        <div class="table-responsive">
            <table id="adminSignalsTable" class="table table-dark table-hover" style="width:100%">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Type</th>
                        <th>User</th>
                        <th>Qty</th>
                        <th>Entry Price</th>
                        <th>Current Price</th>
                        <th>Change %</th>
                        <th>Investment</th>
                        <th>Target</th>
                        <th>P&L</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>Created</th>
                        <th>Days</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded via AJAX -->
                </tbody>
            </table>
        </div>
    </div>

    <div class="card-footer bg-dark border-0 d-flex justify-content-between align-items-center text-light">
        <div class="d-flex align-items-center gap-3">
            <small>Last Updated: <span id="lastUpdate">Loading...</span></small>
        </div>
        <div class="d-flex align-items-center gap-3">
            <small>Total Records: <span id="totalRecords">0</span></small>
        </div>
    </div>
</div>

<!-- Signal Details Modal -->
<div class="modal fade" id="signalDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title text-light">Signal Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="signalDetailsBody">
                <!-- Signal details will be loaded here -->
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<script>
let adminSignalsTable;
let autoRefreshInterval;

$(document).ready(function() {
    initializeDataTable();
    loadPortfolioSummary();
    setupAutoRefresh();

    // Auto refresh toggle
    $('#autoRefreshToggle').change(function() {
        if (this.checked) {
            setupAutoRefresh();
        } else {
            clearInterval(autoRefreshInterval);
        }
    });
});

function initializeDataTable() {
    adminSignalsTable = $('#adminSignalsTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '/etf/datatable/admin-signals',
            type: 'POST',
            contentType: 'application/json',
            data: function(d) {
                return JSON.stringify(d);
            },
            error: function(xhr, error, thrown) {
                console.error('DataTable AJAX error:', error);
                showAlert('Error loading data: ' + error, 'danger');
            }
        },
        columns: [
            { 
                data: 'etf',
                render: function(data, type, row) {
                    return `<strong class="text-primary">${data}</strong>`;
                }
            },
            { 
                data: 'signal_type',
                render: function(data, type, row) {
                    const badgeClass = data === 'BUY' ? 'bg-success' : 'bg-danger';
                    return `<span class="badge ${badgeClass}">${data}</span>`;
                }
            },
            { 
                data: 'target_user_name',
                render: function(data, type, row) {
                    return `<div class="text-truncate" style="max-width: 120px;" title="${data} (${row.target_user_ucc})">${data}<br><small class="text-muted">${row.target_user_ucc}</small></div>`;
                }
            },
            { 
                data: 'qty',
                render: function(data, type, row) {
                    return data ? data.toLocaleString() : '0';
                }
            },
            { 
                data: 'ep',
                render: function(data, type, row) {
                    return `₹${parseFloat(data).toFixed(2)}`;
                }
            },
            { 
                data: 'cmp',
                render: function(data, type, row) {
                    return `₹${parseFloat(data).toFixed(2)}`;
                }
            },
            { 
                data: 'change_pct',
                render: function(data, type, row) {
                    const change = parseFloat(data);
                    const className = change >= 0 ? 'text-success' : 'text-danger';
                    return `<span class="${className} fw-bold">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</span>`;
                }
            },
            { 
                data: 'inv',
                render: function(data, type, row) {
                    return `₹${parseFloat(data).toLocaleString()}`;
                }
            },
            { 
                data: 'tp',
                render: function(data, type, row) {
                    return data > 0 ? `₹${parseFloat(data).toFixed(2)}` : 'N/A';
                }
            },
            { 
                data: 'pl',
                render: function(data, type, row) {
                    const pnl = parseFloat(data);
                    const className = pnl >= 0 ? 'text-success' : 'text-danger';
                    return `<span class="${className} fw-bold">₹${pnl >= 0 ? '+' : ''}${pnl.toLocaleString()}</span>`;
                }
            },
            { 
                data: 'status',
                render: function(data, type, row) {
                    const badgeClass = data === 'ACTIVE' ? 'bg-success' : 'bg-secondary';
                    return `<span class="badge ${badgeClass}">${data}</span>`;
                }
            },
            { 
                data: 'priority',
                render: function(data, type, row) {
                    const badgeClass = data === 'HIGH' ? 'bg-danger' : data === 'MEDIUM' ? 'bg-warning' : 'bg-info';
                    return `<span class="badge ${badgeClass}">${data}</span>`;
                }
            },
            { 
                data: 'date',
                render: function(data, type, row) {
                    return `<small>${data}</small>`;
                }
            },
            { 
                data: 'dh',
                render: function(data, type, row) {
                    return `${data}d`;
                }
            },
            {
                data: null,
                orderable: false,
                render: function(data, type, row) {
                    return `
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewSignalDetails(${row.id})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="createDealFromSignal(${row.id})" title="Create Deal">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    `;
                }
            }
        ],
        order: [[12, 'desc']], // Order by created date descending
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
        responsive: true,
        dom: 'Blfrtip',
        buttons: [
            'copy', 'csv', 'excel',
            {
                text: 'Refresh',
                action: function(e, dt, node, config) {
                    refreshSignals();
                }
            }
        ],
        drawCallback: function(settings) {
            updateSignalsCount();
            updateLastUpdate();
        }
    });
}

function loadPortfolioSummary() {
    fetch('/etf/api/etf-signals-data')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.portfolio) {
                updatePortfolioSummary(data.portfolio);
            }
        })
        .catch(error => {
            console.error('Error loading portfolio summary:', error);
        });
}

function updatePortfolioSummary(portfolio) {
    if (!portfolio) return;

    // Update summary cards
    $('#totalPositions').text(portfolio.total_positions || 0);
    $('#totalInvestment').text(`₹${(portfolio.total_investment || 0).toLocaleString()}`);
    $('#currentValue').text(`₹${(portfolio.current_value || 0).toLocaleString()}`);

    const totalPnl = portfolio.total_pnl || 0;
    const pnlElement = $('#totalPnl');
    pnlElement.text(`₹${totalPnl >= 0 ? '+' : ''}${totalPnl.toLocaleString()}`);
    pnlElement.removeClass('text-success text-danger').addClass(totalPnl >= 0 ? 'text-success' : 'text-danger');

    const returnPercent = portfolio.return_percent || 0;
    const returnElement = $('#returnPercent');
    returnElement.text(`${returnPercent >= 0 ? '+' : ''}${returnPercent.toFixed(2)}%`);
    returnElement.removeClass('text-success text-danger').addClass(returnPercent >= 0 ? 'text-success' : 'text-danger');

    $('#activePositions').text(portfolio.active_positions || 0);
    $('#totalSignals').text(portfolio.total_positions || 0);
}

function updateSignalsCount() {
    const info = adminSignalsTable.page.info();
    $('#signalsCount').text(info.recordsTotal);
    $('#totalRecords').text(info.recordsTotal);
}

function updateLastUpdate() {
    $('#lastUpdate').text(new Date().toLocaleTimeString());
}

function setupAutoRefresh() {
    // Refresh every 60 seconds
    autoRefreshInterval = setInterval(function() {
        refreshSignals();
    }, 60000);
}

function refreshSignals() {
    const refreshBtn = $('#refreshBtn');
    refreshBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...');

    if (adminSignalsTable) {
        adminSignalsTable.ajax.reload(function() {
            loadPortfolioSummary();
            refreshBtn.prop('disabled', false).html('<i class="fas fa-sync-alt me-1"></i>Refresh');
        }, false);
    }
}

function viewSignalDetails(signalId) {
    // Find the signal data from the current table
    const tableData = adminSignalsTable.rows().data();
    let signal = null;

    tableData.each(function(rowData) {
        if (rowData.id === signalId) {
            signal = rowData;
            return false; // break loop
        }
    });

    if (!signal) {
        showAlert('Signal not found', 'warning');
        return;
    }

    const modalBody = $('#signalDetailsBody');
    const html = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-light">Signal Information</h6>
                <table class="table table-dark table-sm">
                    <tr><td><strong>Symbol:</strong></td><td>${signal.etf}</td></tr>
                    <tr><td><strong>Signal Type:</strong></td><td><span class="badge ${signal.signal_type === 'BUY' ? 'bg-success' : 'bg-danger'}">${signal.signal_type}</span></td></tr>
                    <tr><td><strong>Status:</strong></td><td><span class="badge ${signal.status === 'ACTIVE' ? 'bg-success' : 'bg-secondary'}">${signal.status}</span></td></tr>
                    <tr><td><strong>Priority:</strong></td><td><span class="badge ${signal.priority === 'HIGH' ? 'bg-danger' : signal.priority === 'MEDIUM' ? 'bg-warning' : 'bg-info'}">${signal.priority}</span></td></tr>
                    <tr><td><strong>Days Held:</strong></td><td>${signal.dh}</td></tr>
                    <tr><td><strong>Target User:</strong></td><td>${signal.target_user_name} (${signal.target_user_ucc})</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="text-light">Price Information</h6>
                <table class="table table-dark table-sm">
                    <tr><td><strong>Entry Price:</strong></td><td>₹${parseFloat(signal.ep).toFixed(2)}</td></tr>
                    <tr><td><strong>Current Price:</strong></td><td>₹${parseFloat(signal.cmp).toFixed(2)}</td></tr>
                    <tr><td><strong>Target Price:</strong></td><td>₹${signal.tp > 0 ? parseFloat(signal.tp).toFixed(2) : 'N/A'}</td></tr>
                    <tr><td><strong>Quantity:</strong></td><td>${signal.qty.toLocaleString()}</td></tr>
                    <tr><td><strong>Investment:</strong></td><td>₹${parseFloat(signal.inv).toLocaleString()}</td></tr>
                    <tr><td><strong>P&L:</strong></td><td class="${signal.pl >= 0 ? 'text-success' : 'text-danger'}">₹${parseFloat(signal.pl).toLocaleString()}</td></tr>
                    <tr><td><strong>Change %:</strong></td><td class="${signal.change_pct >= 0 ? 'text-success' : 'text-danger'}">${parseFloat(signal.change_pct).toFixed(2)}%</td></tr>
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6 class="text-light">Description</h6>
                <p class="text-light">${signal.nt || 'No description available'}</p>
            </div>
        </div>
    `;

    modalBody.html(html);
    $('#signalDetailsModal').modal('show');
}

function createDealFromSignal(signalId) {
    // Implementation for creating a deal from signal
    showAlert('Deal creation functionality will be implemented soon', 'info');
}

function exportSignals() {
    // Trigger DataTables export
    adminSignalsTable.button('.buttons-csv').trigger();
}

function showAlert(message, type = 'info') {
    // Simple alert implementation
    const alertClass = type === 'danger' ? 'alert-danger' : type === 'success' ? 'alert-success' : type === 'warning' ? 'alert-warning' : 'alert-info';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 1050;" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

    $('body').append(alertHtml);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        $('.alert').fadeOut();
    }, 5000);
}

// Cleanup on page unload
$(window).on('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>
<script>
// Theme management
        function initializeTheme() {
            const themeToggle = document.getElementById('theme-toggle');

            // Only proceed if theme toggle exists
            if (!themeToggle) {
                return;
            }

            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);

            themeToggle.addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);

                // Update icon if it exists
                const icon = themeToggle.querySelector('i');
                if (icon) {
                    icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
                }
            });
        }
</script>
{% endblock %}
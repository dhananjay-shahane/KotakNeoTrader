{% extends "base.html" %}

{% block title %}Admin - Trading Signals Management{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/colreorder/1.7.0/css/colReorder.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

<style>
.admin-header {
    background: linear-gradient(135deg, #dc3545 0%, #6f42c1 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
}

.signals-card {
    border: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-radius: 10px;
}

.table-responsive {
    border-radius: 10px;
    overflow: hidden;
}

.btn-create-signal {
    background: linear-gradient(45deg, #28a745, #20c997);
    border: none;
    color: white;
}

.btn-create-signal:hover {
    background: linear-gradient(45deg, #20c997, #28a745);
    color: white;
}

.admin-stats {
    background: linear-gradient(135deg, #17a2b8 0%, #6610f2 100%);
    color: white;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.live-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    background-color: #28a745;
    border-radius: 50%;
    animation: pulse 1.5s infinite;
    margin-right: 5px;
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
}

.user-badge {
    background: linear-gradient(45deg, #fd7e14, #e83e8c);
    color: white;
    border: none;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
}

.column-toggle {
    margin-bottom: 1rem;
}

.column-toggle .btn {
    margin: 2px;
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-0">
                    <i class="fas fa-cogs me-3"></i>Trading Signals Management
                </h1>
                <p class="mb-0 mt-2">Admin panel for creating and managing ETF trading signals</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-create-signal me-2" data-bs-toggle="modal" data-bs-target="#createSignalModal">
                    <i class="fas fa-plus me-2"></i>Create Signal
                </button>
                <button class="btn btn-outline-light" id="refreshData">
                    <i class="fas fa-sync-alt me-2"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- Admin Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="admin-stats">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">Total Signals</h6>
                        <h4 class="mb-0" id="totalSignals">0</h4>
                    </div>
                    <i class="fas fa-signal fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">Active Signals</h6>
                        <h4 class="mb-0" id="activeSignals">0</h4>
                    </div>
                    <i class="fas fa-play-circle fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">Total Users</h6>
                        <h4 class="mb-0" id="totalUsers">0</h4>
                    </div>
                    <i class="fas fa-users fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="admin-stats">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">ETF Symbols</h6>
                        <h4 class="mb-0" id="totalSymbols">0</h4>
                    </div>
                    <i class="fas fa-chart-pie fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Signals Management Table -->
    <div class="row">
        <div class="col-12">
            <div class="card signals-card">
                <div class="card-header bg-white">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-0">
                                <span class="live-indicator"></span>
                                All Trading Signals
                            </h5>
                        </div>
                        <div class="col-md-6 text-end">
                            <small class="text-muted">
                                Last updated: <span id="lastUpdate">Loading...</span>
                            </small>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <!-- Column Toggle Buttons -->
                    <div class="column-toggle">
                        <label class="form-label fw-bold">Show/Hide Columns:</label>
                        <div id="columnToggles">
                            <!-- Column toggle buttons will be generated here -->
                        </div>
                    </div>

                    <!-- DataTable -->
                    <div class="table-responsive">
                        <table id="adminSignalsTable" class="table table-striped table-hover" style="width:100%">
                            <thead class="table-dark">
                                <tr>
                                    <th>Symbol</th>
                                    <th>Trading Symbol</th>
                                    <th>Signal Type</th>
                                    <th>User</th>
                                    <th>Entry Price</th>
                                    <th>Current Price</th>
                                    <th>Target</th>
                                    <th>Stop Loss</th>
                                    <th>Quantity</th>
                                    <th>Change %</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Expires</th>
                                    <th>Last Update</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded via AJAX -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Signal Modal -->
<div class="modal fade" id="createSignalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Trading Signal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createSignalForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Target User</label>
                                <select class="form-select" name="target_user_id" required>
                                    <option value="">Select User</option>
                                    <!-- Users will be loaded dynamically -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Symbol</label>
                                <input type="text" class="form-control" name="symbol" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Signal Type</label>
                                <select class="form-select" name="signal_type" required>
                                    <option value="BUY">BUY</option>
                                    <option value="SELL">SELL</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Priority</label>
                                <select class="form-select" name="priority">
                                    <option value="HIGH">HIGH</option>
                                    <option value="MEDIUM" selected>MEDIUM</option>
                                    <option value="LOW">LOW</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Entry Price</label>
                                <input type="number" class="form-control" name="entry_price" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Target Price</label>
                                <input type="number" class="form-control" name="target_price" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Stop Loss</label>
                                <input type="number" class="form-control" name="stop_loss" step="0.01">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Quantity</label>
                                <input type="number" class="form-control" name="quantity" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Exchange</label>
                                <select class="form-select" name="exchange">
                                    <option value="NSE" selected>NSE</option>
                                    <option value="BSE">BSE</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Signal Title</label>
                        <input type="text" class="form-control" name="signal_title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="signal_description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-create-signal">Create Signal</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Signal Details Modal -->
<div class="modal fade" id="signalDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Signal Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="signalDetailsBody">
                <!-- Signal details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/colreorder/1.7.0/js/dataTables.colReorder.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

<script>
let adminSignalsTable;
let autoRefreshInterval;

$(document).ready(function() {
    initializeDataTable();
    setupAutoRefresh();
    setupColumnToggles();
    loadUsers();
    
    // Refresh button click
    $('#refreshData').click(function() {
        refreshData();
    });
    
    // Create signal form submission
    $('#createSignalForm').submit(function(e) {
        e.preventDefault();
        createSignal();
    });
});

function initializeDataTable() {
    adminSignalsTable = $('#adminSignalsTable').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '/api/datatable/admin-signals',
            type: 'POST',
            contentType: 'application/json',
            data: function(d) {
                return JSON.stringify(d);
            },
            error: function(xhr, error, thrown) {
                console.error('DataTable AJAX error:', error);
                showAlert('Error loading data: ' + error, 'danger');
            }
        },
        columns: [
            { data: 'symbol', name: 'symbol' },
            { data: 'trading_symbol', name: 'trading_symbol' },
            { data: 'signal_type_badge', name: 'signal_type', orderable: false },
            { 
                data: 'target_user_ucc', 
                name: 'target_user_ucc',
                render: function(data, type, row) {
                    return `<span class="user-badge">${row.target_user_name}</span><br><small>${data}</small>`;
                }
            },
            { data: 'entry_price_formatted', name: 'entry_price' },
            { data: 'current_price_formatted', name: 'current_price' },
            { data: 'target_price_formatted', name: 'target_price', orderable: false },
            { data: 'stop_loss_formatted', name: 'stop_loss', orderable: false },
            { data: 'quantity', name: 'quantity' },
            { 
                data: 'change_percent_formatted', 
                name: 'change_percent',
                render: function(data, type, row) {
                    const change = parseFloat(row.change_percent) || 0;
                    const className = change >= 0 ? 'text-success' : 'text-danger';
                    return `<span class="${className}">${data}</span>`;
                }
            },
            { data: 'priority_badge', name: 'priority', orderable: false },
            { data: 'status_badge', name: 'status', orderable: false },
            { 
                data: 'created_at', 
                name: 'created_at',
                render: function(data) {
                    return data ? new Date(data).toLocaleDateString() : 'N/A';
                }
            },
            { 
                data: 'expires_at', 
                name: 'expires_at',
                render: function(data) {
                    return data ? new Date(data).toLocaleDateString() : 'No Expiry';
                }
            },
            { data: 'last_update', name: 'last_update', orderable: false },
            {
                data: null,
                orderable: false,
                render: function(data, type, row) {
                    return `
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewSignalDetails(${row.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning me-1" onclick="editSignal(${row.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSignal(${row.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                }
            }
        ],
        order: [[12, 'desc']], // Order by created_at descending
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
        responsive: true,
        colReorder: true,
        fixedHeader: true,
        dom: 'Blfrtip',
        buttons: [
            'copy', 'csv', 'excel', 'pdf', 'print',
            {
                text: 'Column visibility',
                extend: 'colvis'
            }
        ],
        drawCallback: function(settings) {
            updateStatistics();
            updateLastUpdate();
        }
    });
}

function setupColumnToggles() {
    const columns = [
        { idx: 1, name: 'Trading Symbol' },
        { idx: 6, name: 'Target' },
        { idx: 7, name: 'Stop Loss' },
        { idx: 8, name: 'Quantity' },
        { idx: 13, name: 'Expires' },
        { idx: 14, name: 'Last Update' }
    ];
    
    const togglesContainer = $('#columnToggles');
    
    columns.forEach(col => {
        const btn = $(`<button class="btn btn-sm btn-outline-secondary" data-column="${col.idx}">
            ${col.name}
        </button>`);
        
        btn.click(function() {
            const column = adminSignalsTable.column(col.idx);
            column.visible(!column.visible());
            $(this).toggleClass('btn-outline-secondary btn-secondary');
        });
        
        togglesContainer.append(btn);
    });
}

function setupAutoRefresh() {
    // Refresh data every 60 seconds for admin view
    autoRefreshInterval = setInterval(function() {
        refreshData();
    }, 60000);
}

function refreshData() {
    if (adminSignalsTable) {
        adminSignalsTable.ajax.reload(null, false);
    }
    
    // Force quote update
    fetch('/api/quotes/force-update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    }).catch(error => {
        console.error('Error forcing quote update:', error);
    });
}

function updateStatistics() {
    const data = adminSignalsTable.data();
    let totalSignals = data.length;
    let activeSignals = 0;
    let uniqueUsers = new Set();
    let uniqueSymbols = new Set();
    
    data.each(function(row) {
        if (row.status === 'ACTIVE') {
            activeSignals++;
        }
        uniqueUsers.add(row.target_user_ucc);
        uniqueSymbols.add(row.symbol);
    });
    
    $('#totalSignals').text(totalSignals);
    $('#activeSignals').text(activeSignals);
    $('#totalUsers').text(uniqueUsers.size);
    $('#totalSymbols').text(uniqueSymbols.size);
}

function updateLastUpdate() {
    $('#lastUpdate').text(new Date().toLocaleTimeString());
}

function loadUsers() {
    fetch('/api/admin/users')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const userSelect = $('select[name="target_user_id"]');
                userSelect.empty().append('<option value="">Select User</option>');
                
                data.users.forEach(user => {
                    userSelect.append(`<option value="${user.id}">${user.greeting_name} (${user.ucc})</option>`);
                });
            }
        })
        .catch(error => {
            console.error('Error loading users:', error);
        });
}

function createSignal() {
    const formData = new FormData($('#createSignalForm')[0]);
    const signalData = {};
    
    for (let [key, value] of formData.entries()) {
        signalData[key] = value;
    }
    
    fetch('/api/admin/create-signal', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(signalData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Signal created successfully!', 'success');
            $('#createSignalModal').modal('hide');
            $('#createSignalForm')[0].reset();
            refreshData();
        } else {
            showAlert('Error creating signal: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error creating signal:', error);
        showAlert('Error creating signal', 'danger');
    });
}

function viewSignalDetails(signalId) {
    fetch(`/api/admin/signal/${signalId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySignalDetails(data.signal);
            } else {
                showAlert('Error loading signal details: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error loading signal details', 'danger');
        });
}

function displaySignalDetails(signal) {
    const modalBody = $('#signalDetailsBody');
    
    const html = `
        <div class="row">
            <div class="col-md-6">
                <h6>Signal Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Symbol:</strong></td><td>${signal.symbol}</td></tr>
                    <tr><td><strong>Trading Symbol:</strong></td><td>${signal.trading_symbol}</td></tr>
                    <tr><td><strong>Signal Type:</strong></td><td>${signal.signal_type}</td></tr>
                    <tr><td><strong>Status:</strong></td><td>${signal.status}</td></tr>
                    <tr><td><strong>Priority:</strong></td><td>${signal.priority}</td></tr>
                    <tr><td><strong>Exchange:</strong></td><td>${signal.exchange}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Price Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>Entry Price:</strong></td><td>₹${parseFloat(signal.entry_price).toLocaleString()}</td></tr>
                    <tr><td><strong>Current Price:</strong></td><td>₹${signal.current_price ? parseFloat(signal.current_price).toLocaleString() : 'N/A'}</td></tr>
                    <tr><td><strong>Target Price:</strong></td><td>₹${signal.target_price ? parseFloat(signal.target_price).toLocaleString() : 'N/A'}</td></tr>
                    <tr><td><strong>Stop Loss:</strong></td><td>₹${signal.stop_loss ? parseFloat(signal.stop_loss).toLocaleString() : 'N/A'}</td></tr>
                    <tr><td><strong>Quantity:</strong></td><td>${signal.quantity}</td></tr>
                    <tr><td><strong>Change %:</strong></td><td class="${parseFloat(signal.change_percent || 0) >= 0 ? 'text-success' : 'text-danger'}">${parseFloat(signal.change_percent || 0).toFixed(2)}%</td></tr>
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>Description</h6>
                <p>${signal.signal_description || 'No description provided'}</p>
                
                <h6>Target User</h6>
                <p><strong>${signal.target_user_name}</strong> (${signal.target_user_ucc})</p>
                
                <h6>Timing</h6>
                <table class="table table-sm">
                    <tr><td><strong>Created:</strong></td><td>${new Date(signal.created_at).toLocaleString()}</td></tr>
                    <tr><td><strong>Updated:</strong></td><td>${signal.updated_at ? new Date(signal.updated_at).toLocaleString() : 'N/A'}</td></tr>
                    <tr><td><strong>Expires:</strong></td><td>${signal.expires_at ? new Date(signal.expires_at).toLocaleString() : 'No expiry'}</td></tr>
                </table>
            </div>
        </div>
    `;
    
    modalBody.html(html);
    $('#signalDetailsModal').modal('show');
}

function editSignal(signalId) {
    // Implement edit functionality
    showAlert('Edit functionality will be implemented soon', 'info');
}

function deleteSignal(signalId) {
    if (confirm('Are you sure you want to delete this signal? This action cannot be undone.')) {
        fetch(`/api/admin/signal/${signalId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Signal deleted successfully!', 'success');
                refreshData();
            } else {
                showAlert('Error deleting signal: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error deleting signal:', error);
            showAlert('Error deleting signal', 'danger');
        });
    }
}

function showAlert(message, type = 'info') {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('.alert').remove();
    $('.container-fluid').prepend(alertHtml);
    
    setTimeout(() => {
        $('.alert').fadeOut();
    }, 5000);
}

// Cleanup on page unload
$(window).on('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>
{% endblock %}
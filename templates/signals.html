
{% extends "base.html" %}

{% block title %}Trading Signals - Kotak Neo Trading{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">Trading Signals</h1>
        <p class="text-muted mb-0">Real-time trading signals and market analysis</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-light" onclick="refreshSignals()">
            <i class="fas fa-sync-alt me-1"></i>Refresh
        </button>
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#columnSettingsModal">
            <i class="fas fa-cog me-1"></i>Columns
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#signalFiltersModal">
            <i class="fas fa-filter me-1"></i>Filters
        </button>
    </div>
</div>

<!-- Signal Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card stats-card border-0 shadow-sm bg-gradient-success">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-uppercase text-white-50 fw-bold mb-1">Long Positions</h6>
                        <h3 class="mb-0 fw-bold text-white" id="buySignalsCount">0</h3>
                        <small class="text-white-50">Active long trades</small>
                    </div>
                    <div class="stats-icon">
                        <i class="fas fa-arrow-up fa-2x text-white"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card stats-card border-0 shadow-sm bg-gradient-danger">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-uppercase text-white-50 fw-bold mb-1">Profitable</h6>
                        <h3 class="mb-0 fw-bold text-white" id="sellSignalsCount">0</h3>
                        <small class="text-white-50">Trades in profit</small>
                    </div>
                    <div class="stats-icon">
                        <i class="fas fa-arrow-down fa-2x text-white"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card stats-card border-0 shadow-sm bg-gradient-warning">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-uppercase text-white fw-bold mb-1">Active Trades</h6>
                        <h3 class="mb-0 fw-bold text-white" id="holdSignalsCount">0</h3>
                        <small class="text-white">Open positions</small>
                    </div>
                    <div class="stats-icon">
                        <i class="fas fa-minus fa-2x text-white"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card stats-card border-0 shadow-sm bg-gradient-info">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-uppercase text-white-50 fw-bold mb-1">Total Holdings</h6>
                        <h3 class="mb-0 fw-bold text-white" id="totalSignalsCount">0</h3>
                        <small class="text-white-50">Last updated: <span id="lastUpdate">--</span></small>
                    </div>
                    <div class="stats-icon">
                        <i class="fas fa-chart-line fa-2x text-white"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Trading Signals Table -->
<div class="row">
    <div class="col-12">
        <div class="card bg-secondary border-0 shadow-lg">
            <div class="card-header bg-dark border-0 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-light">
                    <i class="fas fa-signal me-2 text-primary"></i>Trading Signals
                    <span class="badge bg-primary ms-2" id="visibleSignalsCount">0</span>
                </h5>
                <div class="d-flex gap-2">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
                        <label class="form-check-label text-light" for="autoRefreshToggle">
                            Auto Refresh
                        </label>
                    </div>
                    <button class="btn btn-sm btn-outline-light" onclick="exportSignals()">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                </div>
            </div>
            
            <!-- Summary Row -->
            <div class="card-body p-2" style="background: linear-gradient(90deg, #ffc0cb 0%, #87ceeb 16%, #ffa500 32%, #90ee90 48%, #ffb6c1 64%, #98fb98 80%, #d3d3d3 100%);">
                <div class="d-flex justify-content-between align-items-center text-dark fw-bold" style="font-size: 12px;">
                    <div style="flex: 1; text-align: center; background-color: #ffc0cb; padding: 4px; border-right: 1px solid #fff;">
                        16-Jun
                    </div>
                    <div style="flex: 1; text-align: center; background-color: #87ceeb; padding: 4px; border-right: 1px solid #fff;">
                        Invested:
                    </div>
                    <div style="flex: 1; text-align: center; background-color: #ffa500; padding: 4px; border-right: 1px solid #fff;">
                        4,600,370
                    </div>
                    <div style="flex: 1; text-align: center; background-color: #90ee90; padding: 4px; border-right: 1px solid #fff;">
                        12
                    </div>
                    <div style="flex: 1; text-align: center; background-color: #ffb6c1; padding: 4px; border-right: 1px solid #fff;">
                        44,392
                    </div>
                    <div style="flex: 1; text-align: center; background-color: #d3d3d3; padding: 4px;">
                        31,919
                    </div>
                </div>
            </div>
            
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0" id="signalsTable" style="font-size: 12px;">
                        <thead>
                            <tr>
                                <th class="text-center" style="width: 80px; background-color: #2d3748; color: white; padding: 8px; border: 1px solid #4a5568;">Symbol</th>
                                <th class="text-center" style="width: 60px; background-color: #2d3748; color: white; padding: 8px; border: 1px solid #4a5568;">EP</th>
                                <th class="text-center" style="width: 80px; background-color: #2d3748; color: white; padding: 8px; border: 1px solid #4a5568;">%Ch</th>
                                <th class="text-center" style="width: 80px; background-color: #2d3748; color: white; padding: 8px; border: 1px solid #4a5568;">Date</th>
                                <th class="text-center" style="width: 60px; background-color: #2d3748; color: white; padding: 8px; border: 1px solid #4a5568;">Pos</th>
                                <th class="text-center" style="width: 60px; background-color: #2d3748; color: white; padding: 8px; border: 1px solid #4a5568;">Qty</th>
                                <th class="text-center" style="width: 80px; background-color: #2d3748; color: white; padding: 8px; border: 1px solid #4a5568;">%Chng</th>
                                <th class="text-center" style="width: 80px; background-color: #2d3748; color: white; padding: 8px; border: 1px solid #4a5568;">CMP</th>
                                <th class="text-center" style="width: 80px; background-color: #2d3748; color: white; padding: 8px; border: 1px solid #4a5568;">Val</th>
                                <th class="text-center" style="width: 80px; background-color: #2d3748; color: white; padding: 8px; border: 1px solid #4a5568;">TPR</th>
                                <th class="text-center" style="width: 60px; background-color: #2d3748; color: white; padding: 8px; border: 1px solid #4a5568;">PL</th>
                                <th class="text-center" style="width: 60px; background-color: #2d3748; color: white; padding: 8px; border: 1px solid #4a5568;">ED</th>
                                <th class="text-center" style="width: 80px; background-color: #2d3748; color: white; padding: 8px; border: 1px solid #4a5568;">EXP</th>
                                <th class="text-center" style="width: 60px; background-color: #2d3748; color: white; padding: 8px; border: 1px solid #4a5568;">PR</th>
                                <th class="text-center" style="width: 80px; background-color: #2d3748; color: white; padding: 8px; border: 1px solid #4a5568;">PP</th>
                                <th class="text-center" style="width: 80px; background-color: #2d3748; color: white; padding: 8px; border: 1px solid #4a5568;">IV</th>
                                <th class="text-center" style="width: 80px; background-color: #2d3748; color: white; padding: 8px; border: 1px solid #4a5568;">SI</th>
                                <th class="text-center" style="width: 60px; background-color: #2d3748; color: white; padding: 8px; border: 1px solid #4a5568;">%Ch2</th>
                            </tr>
                        </thead>
                        <tbody id="signalsTableBody">
                            <!-- Signal data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-dark border-0 d-flex justify-content-between align-items-center text-light">
                <div>
                    <small>Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> signals</small>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-light" onclick="previousPage()" id="prevBtn" disabled>
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-light" disabled>
                        Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-light" onclick="nextPage()" id="nextBtn" disabled>
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Column Settings Modal -->
<div class="modal fade" id="columnSettingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title">
                    <i class="fas fa-cog me-2"></i>Column Settings
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Select which columns to display in the trading signals table:</p>
                <div class="row" id="columnCheckboxes">
                    <!-- Column checkboxes will be populated here -->
                </div>
                <hr class="border-secondary">
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllColumns()">Select All</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetDefaultColumns()">Reset to Default</button>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="applyColumnSettings()">Apply Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Signal Filters Modal -->
<div class="modal fade" id="signalFiltersModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title">
                    <i class="fas fa-filter me-2"></i>Signal Filters
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Signal Type</label>
                    <select class="form-select bg-secondary text-light" id="signalTypeFilter">
                        <option value="">All Signals</option>
                        <option value="BUY">Buy Signals</option>
                        <option value="SELL">Sell Signals</option>
                        <option value="HOLD">Hold Signals</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Strength</label>
                    <select class="form-select bg-secondary text-light" id="strengthFilter">
                        <option value="">All Strengths</option>
                        <option value="STRONG">Strong</option>
                        <option value="MEDIUM">Medium</option>
                        <option value="WEAK">Weak</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Sector</label>
                    <select class="form-select bg-secondary text-light" id="sectorFilter">
                        <option value="">All Sectors</option>
                        <option value="Banking">Banking</option>
                        <option value="IT">IT Services</option>
                        <option value="Auto">Automobile</option>
                        <option value="Pharma">Pharmaceuticals</option>
                        <option value="FMCG">FMCG</option>
                        <option value="Energy">Energy</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Price Range</label>
                    <div class="row">
                        <div class="col-6">
                            <input type="number" class="form-control bg-secondary text-light" placeholder="Min Price" id="minPriceFilter">
                        </div>
                        <div class="col-6">
                            <input type="number" class="form-control bg-secondary text-light" placeholder="Max Price" id="maxPriceFilter">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
                <button type="button" class="btn btn-primary" onclick="applyFilters()" data-bs-dismiss="modal">Apply Filters</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Trading Signals Management
class TradingSignalsManager {
    constructor() {
        this.signals = [];
        this.filteredSignals = [];
        this.currentPage = 1;
        this.pageSize = 20;
        this.autoRefresh = true;
        this.refreshInterval = null;
        
        // Available columns configuration matching Excel format exactly
        this.availableColumns = {
            'stf': { label: 'STF', default: true, width: '100px' },
            'thirty': { label: '30', default: true, width: '60px' },
            'dh': { label: 'DH', default: true, width: '80px' },
            'date': { label: 'Date', default: true, width: '100px' },
            'pos': { label: 'Pos', default: true, width: '60px' },
            'qty': { label: 'Qty', default: true, width: '80px' },
            'ep': { label: 'EP', default: true, width: '80px' },
            'cmp': { label: 'CMP', default: true, width: '80px' },
            'change': { label: '% %Chng', default: true, width: '80px' },
            'inv': { label: 'Inv', default: true, width: '100px' },
            'tp': { label: 'TP', default: true, width: '80px' },
            'twa': { label: 'TWA', default: true, width: '100px' },
            'tpr': { label: 'TPR', default: true, width: '80px' },
            'pl': { label: 'PL', default: true, width: '80px' },
            'ed': { label: 'ED', default: true, width: '100px' },
            'exp': { label: 'EXP', default: true, width: '80px' },
            'pr': { label: 'PR', default: true, width: '60px' },
            'pp': { label: 'PP', default: true, width: '80px' },
            'iv': { label: 'IV', default: true, width: '100px' },
            'si': { label: 'SI', default: true, width: '80px' },
            'ol': { label: 'OL', default: true, width: '60px' },
            'gamma': { label: 'γ', default: true, width: '60px' },
            'chng': { label: '%Ch', default: true, width: '80px' }
        };
        
        this.selectedColumns = this.getDefaultColumns();
        this.init();
    }
    
    getDefaultColumns() {
        return Object.keys(this.availableColumns).filter(col => this.availableColumns[col].default);
    }
    
    init() {
        this.generateColumnCheckboxes();
        this.updateTableHeaders();
        this.loadSignals();
        this.startAutoRefresh();
        
        // Event listeners
        document.getElementById('autoRefreshToggle').addEventListener('change', (e) => {
            this.autoRefresh = e.target.checked;
            if (this.autoRefresh) {
                this.startAutoRefresh();
            } else {
                this.stopAutoRefresh();
            }
        });
    }
    
    generateColumnCheckboxes() {
        const container = document.getElementById('columnCheckboxes');
        container.innerHTML = '';
        
        Object.keys(this.availableColumns).forEach(column => {
            const colInfo = this.availableColumns[column];
            const colDiv = document.createElement('div');
            colDiv.className = 'col-md-6 col-lg-4 mb-2';
            
            colDiv.innerHTML = `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="col_${column}" 
                           ${this.selectedColumns.includes(column) ? 'checked' : ''}>
                    <label class="form-check-label" for="col_${column}">
                        ${colInfo.label}
                    </label>
                </div>
            `;
            
            container.appendChild(colDiv);
        });
    }
    
    updateTableHeaders() {
        const headersRow = document.getElementById('tableHeaders');
        headersRow.innerHTML = '';
        
        this.selectedColumns.forEach(column => {
            const th = document.createElement('th');
            const colInfo = this.availableColumns[column];
            th.style.width = colInfo.width;
            th.className = 'text-center';
            th.textContent = colInfo.label;
            headersRow.appendChild(th);
        });
    }
    
    async loadSignals() {
        try {
            // Generate sample trading signals data
            this.signals = this.generateSampleSignals();
            this.filteredSignals = [...this.signals];
            this.updateSignalCounts();
            this.renderSignalsTable();
            this.updatePagination();
            
        } catch (error) {
            console.error('Error loading signals:', error);
            this.showError('Failed to load trading signals');
        }
    }
    
    generateSampleSignals() {
        // Real trading data structure matching Excel image exactly
        return [
            {
                symbol: 'MOEDHUSHEES',
                ep: 227.60,
                change: -1.96,
                date: '22-Nov-2024',
                pos: 1,
                qty: 200,
                change_pct: -1.96,
                cmp: 223.56,
                val: 45504,
                tpr: 12.028,
                pl: -808,
                ed: 44696,
                exp: 2.94,
                pr: 4,
                pp: 669.9,
                iv: 45504,
                si: 1.31,
                change2: -1.96
            },
            {
                symbol: 'TETF',
                ep: 40.38,
                change: 0.00,
                date: '13-Dec-2024',
                pos: 1,
                qty: 500,
                change_pct: -14.32,
                cmp: 52.79,
                val: 23565,
                tpr: 12.028,
                pl: -3375,
                ed: 26395,
                exp: 7.41,
                pr: 14,
                pp: 7609.8,
                iv: 36650,
                si: 2.59,
                change2: 3.39
            },
            {
                symbol: 'CONSUMBEES',
                ep: 127.2,
                change: 0.76,
                date: '20-Dec-2024',
                pos: 0,
                qty: 100,
                change_pct: 0.00,
                cmp: 127.2,
                val: 0,
                tpr: 0.000,
                pl: 0,
                ed: '2-Jan-2025',
                exp: 12.1,
                pr: 31,
                pp: 2869.8,
                iv: 26810,
                si: 29410,
                change2: 1.31
            },
            {
                symbol: 'SILVERBEES',
                ep: 104.25,
                change: -0.76,
                date: '16-Dec-2024',
                pos: 0,
                qty: 1100,
                change_pct: 0.00,
                cmp: 103.44,
                val: 103464,
                tpr: 0.000,
                pl: 0,
                ed: '30-Jan-2025',
                exp: 88.87,
                pr: 198,
                pp: 1008.6,
                iv: 100100,
                si: 2.22,
                change2: 0.48
            },
            {
                symbol: 'SILVRBEES',
                ep: 104.25,
                change: -0.76,
                date: '22-Nov-2024',
                pos: 0,
                qty: 607,
                change_pct: 0.00,
                cmp: 95,
                val: 83.1,
                tpr: 0.000,
                pl: 0,
                ed: '14-Feb-2025',
                exp: 91.3,
                pr: 12.1,
                pp: 1008.6,
                iv: 162780,
                si: 2.22,
                change2: 0.48
            },
            {
                symbol: 'GOLDBEES',
                ep: 83.83,
                change: -0.86,
                date: '28-Nov-2024',
                pos: 0,
                qty: 100,
                change_pct: 0.00,
                cmp: 64,
                val: 83.1,
                tpr: 0.000,
                pl: 0,
                ed: '20-Mar-2025',
                exp: 2.3,
                pr: 3,
                pp: 0,
                iv: 0,
                si: 0.00,
                change2: 3.96
            }
        ];
    }
    
    updateSignalCounts() {
        const longPositions = this.filteredSignals.filter(s => s.pos === 1).length;
        const profitableSignals = this.filteredSignals.filter(s => s.pl > 0).length;
        const activeSignals = this.filteredSignals.filter(s => s.pl !== 0).length;
        
        document.getElementById('buySignalsCount').textContent = longPositions;
        document.getElementById('sellSignalsCount').textContent = profitableSignals;
        document.getElementById('holdSignalsCount').textContent = activeSignals;
        document.getElementById('totalSignalsCount').textContent = this.filteredSignals.length;
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        
        // Summary row is now static
    }
    
    // Summary row is now static with fixed values matching the image
    
    renderSignalsTable() {
        const tbody = document.getElementById('signalsTableBody');
        const startIndex = (this.currentPage - 1) * this.pageSize;
        const endIndex = startIndex + this.pageSize;
        const pageSignals = this.filteredSignals.slice(startIndex, endIndex);
        
        tbody.innerHTML = '';
        
        if (pageSignals.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td colspan="${this.selectedColumns.length}" class="text-center py-4">
                    <i class="fas fa-search fa-3x mb-3 text-muted"></i>
                    <h6 class="text-muted">No signals found</h6>
                    <p class="text-muted mb-0">Try adjusting your filters</p>
                </td>
            `;
            tbody.appendChild(row);
            return;
        }
        
        pageSignals.forEach(signal => {
            const row = document.createElement('tr');
            
            // Create cells matching Excel column order
            const columns = ['symbol', 'ep', 'change', 'date', 'pos', 'qty', 'change_pct', 'cmp', 'val', 'tpr', 'pl', 'ed', 'exp', 'pr', 'pp', 'iv', 'si', 'change2'];
            
            columns.forEach(columnKey => {
                const cell = document.createElement('td');
                cell.className = 'text-center';
                cell.style.padding = '6px 4px';
                cell.style.border = '1px solid #4a5568';
                cell.style.fontSize = '11px';
                
                let cellContent = '';
                let bgColor = '';
                
                switch(columnKey) {
                    case 'symbol':
                        cellContent = `<strong style="color: #fff;">${signal.symbol || ''}</strong>`;
                        break;
                    case 'ep':
                        cellContent = signal.ep ? signal.ep.toFixed(2) : '';
                        break;
                    case 'change':
                        if (signal.change !== undefined) {
                            bgColor = signal.change >= 0 ? '#16a085' : '#e74c3c';
                            cellContent = `${signal.change >= 0 ? '+' : ''}${signal.change.toFixed(2)}`;
                        }
                        break;
                    case 'date':
                        cellContent = signal.date || '';
                        break;
                    case 'pos':
                        cellContent = signal.pos !== undefined ? signal.pos : '';
                        if (signal.pos === 1) bgColor = '#f39c12';
                        break;
                    case 'qty':
                        cellContent = signal.qty ? signal.qty.toLocaleString('en-IN') : '';
                        break;
                    case 'change_pct':
                        if (signal.change_pct !== undefined) {
                            bgColor = signal.change_pct >= 0 ? '#16a085' : '#e74c3c';
                            cellContent = `${signal.change_pct >= 0 ? '+' : ''}${signal.change_pct.toFixed(2)}%`;
                        }
                        break;
                    case 'cmp':
                        cellContent = signal.cmp ? signal.cmp.toFixed(2) : '';
                        break;
                    case 'val':
                        cellContent = signal.val ? signal.val.toLocaleString('en-IN') : '0';
                        if (signal.val > 0) bgColor = '#3498db';
                        break;
                    case 'tpr':
                        cellContent = signal.tpr ? signal.tpr.toFixed(3) : '0.000';
                        break;
                    case 'pl':
                        if (signal.pl !== undefined) {
                            bgColor = signal.pl >= 0 ? '#16a085' : '#e74c3c';
                            cellContent = `${signal.pl >= 0 ? '+' : ''}${signal.pl}`;
                        }
                        break;
                    case 'ed':
                        cellContent = typeof signal.ed === 'string' ? signal.ed : (signal.ed ? signal.ed.toLocaleString('en-IN') : '');
                        break;
                    case 'exp':
                        cellContent = signal.exp ? signal.exp.toFixed(2) : '';
                        break;
                    case 'pr':
                        cellContent = signal.pr || '';
                        break;
                    case 'pp':
                        cellContent = signal.pp ? signal.pp.toFixed(1) : '';
                        break;
                    case 'iv':
                        cellContent = signal.iv ? signal.iv.toLocaleString('en-IN') : '';
                        break;
                    case 'si':
                        cellContent = signal.si ? signal.si.toFixed(2) : '';
                        break;
                    case 'change2':
                        if (signal.change2 !== undefined) {
                            bgColor = signal.change2 >= 0 ? '#16a085' : '#e74c3c';
                            cellContent = `${signal.change2 >= 0 ? '+' : ''}${signal.change2.toFixed(2)}`;
                        }
                        break;
                    default:
                        cellContent = '';
                }
                
                if (bgColor) {
                    cell.style.backgroundColor = bgColor;
                    cell.style.color = 'white';
                    cell.style.fontWeight = 'bold';
                }
                
                cell.innerHTML = cellContent;
                row.appendChild(cell);
            });
            
            tbody.appendChild(row);
        });
        
        document.getElementById('visibleSignalsCount').textContent = this.filteredSignals.length;
        document.getElementById('showingCount').textContent = Math.min(endIndex, this.filteredSignals.length);
        document.getElementById('totalCount').textContent = this.filteredSignals.length;
    }
    
    updatePagination() {
        const totalPages = Math.ceil(this.filteredSignals.length / this.pageSize);
        
        document.getElementById('currentPage').textContent = this.currentPage;
        document.getElementById('totalPages').textContent = totalPages;
        
        document.getElementById('prevBtn').disabled = this.currentPage <= 1;
        document.getElementById('nextBtn').disabled = this.currentPage >= totalPages;
    }
    
    applyFilters() {
        const signalType = document.getElementById('signalTypeFilter').value;
        const strength = document.getElementById('strengthFilter').value;
        const sector = document.getElementById('sectorFilter').value;
        const minPrice = parseFloat(document.getElementById('minPriceFilter').value) || 0;
        const maxPrice = parseFloat(document.getElementById('maxPriceFilter').value) || Infinity;
        
        this.filteredSignals = this.signals.filter(signal => {
            return (!signalType || signal.signal === signalType) &&
                   (!strength || signal.strength === strength) &&
                   (!sector || signal.sector === sector) &&
                   (parseFloat(signal.price) >= minPrice && parseFloat(signal.price) <= maxPrice);
        });
        
        this.currentPage = 1;
        this.updateSignalCounts();
        this.renderSignalsTable();
        this.updatePagination();
    }
    
    clearFilters() {
        document.getElementById('signalTypeFilter').value = '';
        document.getElementById('strengthFilter').value = '';
        document.getElementById('sectorFilter').value = '';
        document.getElementById('minPriceFilter').value = '';
        document.getElementById('maxPriceFilter').value = '';
        
        this.filteredSignals = [...this.signals];
        this.currentPage = 1;
        this.updateSignalCounts();
        this.renderSignalsTable();
        this.updatePagination();
    }
    
    applyColumnSettings() {
        this.selectedColumns = [];
        
        Object.keys(this.availableColumns).forEach(column => {
            const checkbox = document.getElementById(`col_${column}`);
            if (checkbox && checkbox.checked) {
                this.selectedColumns.push(column);
            }
        });
        
        this.updateTableHeaders();
        this.renderSignalsTable();
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('columnSettingsModal'));
        modal.hide();
    }
    
    startAutoRefresh() {
        if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
        }
        
        if (this.autoRefresh) {
            this.refreshInterval = setInterval(() => {
                this.loadSignals();
            }, 30000); // Refresh every 30 seconds
        }
    }
    
    stopAutoRefresh() {
        if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
            this.refreshInterval = null;
        }
    }
    
    showError(message) {
        const tbody = document.getElementById('signalsTableBody');
        tbody.innerHTML = `
            <tr>
                <td colspan="${this.selectedColumns.length}" class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3 text-danger"></i>
                    <h6 class="text-danger">${message}</h6>
                    <button class="btn btn-outline-primary btn-sm mt-2" onclick="signalsManager.loadSignals()">
                        <i class="fas fa-sync me-1"></i>Retry
                    </button>
                </td>
            </tr>
        `;
    }
}

// Global functions
function refreshSignals() {
    window.signalsManager.loadSignals();
}

function selectAllColumns() {
    Object.keys(window.signalsManager.availableColumns).forEach(column => {
        const checkbox = document.getElementById(`col_${column}`);
        if (checkbox) checkbox.checked = true;
    });
}

function resetDefaultColumns() {
    Object.keys(window.signalsManager.availableColumns).forEach(column => {
        const checkbox = document.getElementById(`col_${column}`);
        if (checkbox) {
            checkbox.checked = window.signalsManager.availableColumns[column].default;
        }
    });
}

function applyColumnSettings() {
    window.signalsManager.applyColumnSettings();
}

function applyFilters() {
    window.signalsManager.applyFilters();
}

function clearFilters() {
    window.signalsManager.clearFilters();
}

function previousPage() {
    if (window.signalsManager.currentPage > 1) {
        window.signalsManager.currentPage--;
        window.signalsManager.renderSignalsTable();
        window.signalsManager.updatePagination();
    }
}

function nextPage() {
    const totalPages = Math.ceil(window.signalsManager.filteredSignals.length / window.signalsManager.pageSize);
    if (window.signalsManager.currentPage < totalPages) {
        window.signalsManager.currentPage++;
        window.signalsManager.renderSignalsTable();
        window.signalsManager.updatePagination();
    }
}

function viewSignalDetails(symbol) {
    alert(`Viewing details for ${symbol}`);
}

function placeOrder(signal, symbol, price) {
    if (window.openPlaceOrderModal) {
        window.openPlaceOrderModal(signal, symbol);
    } else {
        // Simulate placing order and redirect to deals page
        const confirmed = confirm(`Place ${signal} order for ${symbol} at ₹${price}?`);
        if (confirmed) {
            // In a real implementation, this would make an API call to place the order
            alert(`Order placed successfully for ${symbol}. Check the Deals page to track this order.`);
            // Optionally redirect to deals page
            // window.location.href = '/deals';
        }
    }
}

function addToWatchlist(symbol) {
    alert(`Added ${symbol} to watchlist`);
}

function exportSignals() {
    const data = window.signalsManager.filteredSignals;
    const csvContent = "data:text/csv;charset=utf-8," + 
        Object.keys(data[0]).join(",") + "\n" +
        data.map(row => Object.values(row).join(",")).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `trading_signals_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    window.signalsManager = new TradingSignalsManager();
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Dashboard - Kotak Neo Trading{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1 class="h3 mb-1">Trading Dashboard</h1>
        <p class="text-muted mb-0">Real-time portfolio overview and market data</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" onclick="refreshDashboard()">
            <i class="fas fa-sync-alt"></i>
            Refresh Data
        </button>
        <button class="btn btn-primary" onclick="openPlaceOrderModal('BUY')">
            <i class="fas fa-plus"></i>
            Place Order
        </button>
    </div>
</div>

<!-- User Welcome Section -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card bg-gradient-primary border-0 shadow-lg">
            <div class="card-body p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center">
                            <div class="user-avatar-large me-3">
                                <i class="fas fa-user-circle fa-3x text-white"></i>
                            </div>
                            <div>
                                <h3 class="text-white mb-1">Welcome back, {{ session.get('ucc', 'Trader') }}!</h3>
                                <p class="text-white-50 mb-0">
                                    <i class="fas fa-clock me-1"></i>
                                    Last login: <span id="lastLoginTime">Today</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-outline-light btn-lg" onclick="showUserProfile()">
                            <i class="fas fa-user-cog me-2"></i>View Profile
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Portfolio Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card stats-card border-0 shadow-sm bg-gradient-primary">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-uppercase text-white-50 fw-bold mb-2">Total Positions</h6>
                        <h2 class="mb-0 fw-bold text-white" id="totalPositions">{{ data.total_positions or 0 }}</h2>
                        <small class="text-white-50">
                            <i class="fas fa-chart-line me-1"></i>
                            {% set active_positions = data.positions|selectattr('netQty', '!=', '0')|list|length if data.positions else 0 %}
                            {{ active_positions }} Active trades
                        </small>
                    </div>
                    <div class="stats-icon">
                        <div class="bg-white bg-opacity-20 rounded-circle p-3">
                            <i class="fas fa-chart-pie fa-2x text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card stats-card border-0 shadow-sm bg-gradient-success">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-uppercase text-white-50 fw-bold mb-2">Total Holdings</h6>
                        <h2 class="mb-0 fw-bold text-white" id="totalHoldings">{{ data.total_holdings or 0 }}</h2>
                        <small class="text-white-50" id="holdingsValue">
                            <i class="fas fa-wallet me-1"></i>
                            {% if data.holdings %}
                                {% set holdings_value = data.holdings|sum(attribute='mktPrice')|float if data.holdings else 0.0 %}
                                ₹{{ "%.2f"|format(holdings_value) }}
                            {% else %}
                                ₹0.00
                            {% endif %}
                        </small>
                    </div>
                    <div class="stats-icon">
                        <div class="bg-white bg-opacity-20 rounded-circle p-3">
                            <i class="fas fa-briefcase fa-2x text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card stats-card border-0 shadow-sm bg-gradient-info">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-uppercase text-white-50 fw-bold mb-2">Today's Orders</h6>
                        <h2 class="mb-0 fw-bold text-white" id="totalOrders">
                            {% if data.recent_orders %}
                                {{ data.recent_orders|length }}
                            {% else %}
                                0
                            {% endif %}
                        </h2>
                        <small class="text-white-50">
                            <i class="fas fa-clock me-1"></i>
                            {% set pending_orders = data.recent_orders|selectattr('ordSt', '==', 'open')|list|length if data.recent_orders else 0 %}
                            {{ pending_orders }} Pending
                        </small>
                    </div>
                    <div class="stats-icon">
                        <div class="bg-white bg-opacity-20 rounded-circle p-3">
                            <i class="fas fa-list-alt fa-2x text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card stats-card border-0 shadow-sm bg-gradient-warning">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title text-uppercase text-white fw-bold mb-2">Available Margin</h6>
                        <h2 class="mb-0 fw-bold text-white" id="availableMargin">
                            {% if data.limits and data.limits.Net %}
                                ₹{{ "{:,.2f}"|format(data.limits.Net|float) }}
                            {% else %}
                                ₹0.00
                            {% endif %}
                        </h2>
                        <small class="text-white" id="marginUsed">
                            <i class="fas fa-rupee-sign me-1"></i>
                            {% if data.limits and data.limits.MarginUsed %}
                                Used: ₹{{ "{:,.2f}"|format(data.limits.MarginUsed|float) }}
                            {% else %}
                                Ready to trade
                            {% endif %}
                        </small>
                    </div>
                    <div class="stats-icon">
                        <div class="bg-white bg-opacity-20 rounded-circle p-3">
                            <i class="fas fa-coins fa-2x text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Positions Table -->
<div class="row mb-4">
    <div class="col">
        <div class="card bg-secondary border-0 shadow-lg">
            <div class="card-header bg-dark border-0 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-light">
                    <i class="fas fa-chart-pie me-2 text-info"></i>Current Positions
                </h5>
                <div>
                    <button class="btn btn-sm btn-success me-2" onclick="openPlaceOrderModal('BUY')">
                        <i class="fas fa-plus me-1"></i>Place Order
                    </button>
                    <button class="btn btn-sm btn-outline-light" onclick="refreshDashboard()">
                        <i class="fas fa-sync me-1"></i>Refresh
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0" id="positionsTable">
                        <thead class="table-dark">
                            <tr>
                                <th><i class="fas fa-tag me-1"></i>Symbol</th>
                                <th><i class="fas fa-balance-scale me-1"></i>Quantity</th>
                                <th><i class="fas fa-rupee-sign me-1"></i>Avg Price</th>
                                <th><i class="fas fa-chart-line me-1"></i>LTP</th>
                                <th><i class="fas fa-calculator me-1"></i>P&L</th>
                                <th><i class="fas fa-percentage me-1"></i>P&L %</th>
                                <th><i class="fas fa-coins me-1"></i>Value</th>
                                <th><i class="fas fa-cogs me-1"></i>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="positionsTableBody">
                            {% if data.positions and data.positions|length > 0 %}
                                {% for position in data.positions %}
                                    {% set net_qty = (position.flBuyQty|int) - (position.flSellQty|int) %}
                                    {% if net_qty != 0 %}
                                    {% set avg_price = ((position.buyAmt|float) - (position.sellAmt|float)) / net_qty if net_qty != 0 else 0 %}
                                    {% set current_price = position.ltp|float if position.ltp else (position.stkPrc|float if position.stkPrc else 0) %}
                                    {% set current_value = current_price * net_qty %}
                                    {% set pnl = current_value - (avg_price * net_qty) %}
                                    {% set pnl_percent = (pnl / (avg_price * net_qty) * 100) if avg_price != 0 and net_qty != 0 else 0 %}
                                    <tr data-symbol="{{ position.trdSym or position.sym }}" data-token="{{ position.tok }}">
                                        <td>
                                            <div>
                                                <strong class="text-primary">{{ position.trdSym or position.sym or 'N/A' }}</strong>
                                                <br><small class="text-muted">{{ position.exSeg or 'NSE' }} • {{ position.prod or 'CNC' }}</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column">
                                                <span class="fw-bold {% if net_qty > 0 %}text-success{% else %}text-danger{% endif %}">
                                                    {{ net_qty }}
                                                </span>
                                                <small class="text-muted">
                                                    {% if position.flBuyQty|int > 0 %}B: {{ position.flBuyQty }}{% endif %}
                                                    {% if position.flSellQty|int > 0 %}{% if position.flBuyQty|int > 0 %} | {% endif %}S: {{ position.flSellQty }}{% endif %}
                                                </small>
                                            </div>
                                        </td>
                                        <td class="fw-bold">
                                            ₹{{ "{:,.2f}"|format(avg_price) }}
                                        </td>
                                        <td class="price-ltp fw-bold text-warning" data-symbol="{{ position.trdSym or position.sym }}">
                                            ₹{{ "{:,.2f}"|format(current_price) }}
                                        </td>
                                        <td class="{% if pnl > 0 %}text-success{% elif pnl < 0 %}text-danger{% else %}text-muted{% endif %} fw-bold">
                                            {{ "{:+,.2f}"|format(pnl) }}
                                        </td>
                                        <td class="{% if pnl_percent > 0 %}text-success{% elif pnl_percent < 0 %}text-danger{% else %}text-muted{% endif %} fw-bold">
                                            {{ "{:+.2f}"|format(pnl_percent) }}%
                                        </td>
                                        <td class="fw-bold">
                                            ₹{{ "{:,.2f}"|format(current_value) }}
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                {% if net_qty > 0 %}
                                                    <button class="btn btn-sm btn-danger square-off-btn" 
                                                            data-symbol="{{ position.trdSym or position.sym }}"
                                                            data-quantity="{{ net_qty }}"
                                                            data-token="{{ position.tok }}"
                                                            data-exchange="{{ position.exSeg or 'NSE' }}"
                                                            data-product="{{ position.prod or 'CNC' }}"
                                                            title="Square Off">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                {% endif %}
                                                <button class="btn btn-sm btn-success place-order-btn" 
                                                        data-type="BUY"
                                                        data-symbol="{{ position.trdSym or position.sym }}"
                                                        data-token="{{ position.tok }}"
                                                        data-exchange="{{ position.exSeg or 'NSE' }}"
                                                        title="Buy More">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                                <button class="btn btn-sm btn-warning place-order-btn" 
                                                        data-type="SELL"
                                                        data-symbol="{{ position.trdSym or position.sym }}"
                                                        data-token="{{ position.tok }}"
                                                        data-exchange="{{ position.exSeg or 'NSE' }}"
                                                        title="Sell">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <button class="btn btn-sm btn-info position-details-btn" 
                                                        data-symbol="{{ position.trdSym or position.sym }}"
                                                        data-position="{{ position|tojson|e }}"
                                                        title="Details">
                                                    <i class="fas fa-info-circle"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-5">
                                        <i class="fas fa-chart-pie fa-4x mb-3 d-block text-muted"></i>
                                        <h5>No Active Positions</h5>
                                        <p class="mb-3">Start trading to see your positions here</p>
                                        <button class="btn btn-primary btn-lg" onclick="openPlaceOrderModal('BUY')">
                                            <i class="fas fa-plus me-2"></i>Place Your First Order
                                        </button>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>





<!-- Recent Orders -->
{% if data.recent_orders %}
<div class="row mb-4">
    <div class="col">
        <div class="card bg-secondary">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list-alt me-2"></i>Recent Orders
                </h5>
                <a href="{{ url_for('orders') }}" class="btn btn-sm btn-outline-light">View All</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in data.recent_orders %}
                            <tr>
                                <td>{{ order.orderTime or 'N/A' }}</td>
                                <td><strong>{{ order.trdSym or 'N/A' }}</strong></td>
                                <td>
                                    <span class="badge {% if order.transType == 'BUY' %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ order.transType or 'N/A' }}
                                    </span>
                                </td>
                                <td>{{ order.qty or '0' }}</td>
                                <td>₹{{ "%.2f"|format(order.prc|float) if order.prc else '0.00' }}</td>
                                <td>
                                    <span class="badge {% if order.ordSt == 'complete' %}bg-success{% elif order.ordSt == 'rejected' %}bg-danger{% else %}bg-warning{% endif %}">
                                        {{ order.ordSt or 'N/A' }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- User Profile Modal -->
<div class="modal fade" id="userProfileModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title">
                    <i class="fas fa-user-circle me-2"></i>User Profile
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center mb-4">
                        <div class="user-profile-avatar mb-3">
                            <i class="fas fa-user-circle fa-5x text-primary"></i>
                        </div>
                        <h4 class="text-light">{{ session.get('ucc', 'User') }}</h4>
                        <span class="badge bg-success">Active Trader</span>
                    </div>
                    <div class="col-md-8">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-info-circle me-2"></i>Account Information
                        </h6>
                        <div class="row">
                            <div class="col-sm-6 mb-3">
                                <label class="form-label text-muted">UCC (User Code)</label>
                                <div class="form-control bg-secondary text-light border-0">
                                    {{ session.get('ucc', 'N/A') }}
                                </div>
                            </div>
                            <div class="col-sm-6 mb-3">
                                <label class="form-label text-muted">Account Status</label>
                                <div class="form-control bg-secondary text-light border-0">
                                    <span class="text-success"><i class="fas fa-check-circle me-1"></i>Active</span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-6 mb-3">
                                <label class="form-label text-muted">Session Token</label>
                                <div class="form-control bg-secondary text-light border-0" style="font-family: monospace; font-size: 0.8rem;">
                                    {{ session.get('session_token', 'N/A')[:20] if session.get('session_token') else 'N/A' }}...
                                </div>
                            </div>
                            <div class="col-sm-6 mb-3">
                                <label class="form-label text-muted">Access Token</label>
<div class="form-control bg-secondary text-light border-0" style="font-family: monospace; font-size: 0.8rem;">
                                    {{ session.get('access_token', 'N/A')[:20] if session.get('access_token') else 'N/A' }}...
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-6 mb-3">
                                <label class="form-label text-muted">Login Time</label>
                                <div class="form-control bg-secondary text-light border-0">
                                    <span id="loginTime">{{ session.get('login_time', 'Today') }}</span>
                                </div>
                            </div>
                            <div class="col-sm-6 mb-3">
                                <label class="form-label text-muted">Session ID</label>
                                <div class="form-control bg-secondary text-light border-0" style="font-family: monospace; font-size: 0.8rem;">
                                    {{ session.get('sid', 'N/A')[:15] if session.get('sid') else 'N/A' }}...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="border-secondary">

                <h6 class="text-primary mb-3">
                    <i class="fas fa-shield-alt me-2"></i>Security & Settings
                </h6>
                <div class="row">
                    <div class="col-md-6">
                        <div class="list-group list-group-flush">
                            <div class="list-group-item bg-transparent text-light border-secondary">
                                <i class="fas fa-key me-2 text-success"></i>
                                Two-Factor Authentication: <span class="text-success">Enabled</span>
                            </div>
                            <div class="list-group-item bg-transparent text-light border-secondary">
                                <i class="fas fa-clock me-2 text-info"></i>
                                Session Timeout: <span class="text-info">30 minutes</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="list-group list-group-flush">
                            <div class="list-group-item bg-transparent text-light border-secondary">
                                <i class="fas fa-chart-line me-2 text-warning"></i>
                                Trading Status: <span class="text-success">Active</span>
                            </div>
                            <div class="list-group-item bg-transparent text-light border-secondary">
                                <i class="fas fa-database me-2 text-primary"></i>
                                Data Refresh: <span class="text-info">Real-time</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="showAccountSummary()">
                    <i class="fas fa-chart-bar me-1"></i>View Account Summary
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Account Summary Modal -->
<div class="modal fade" id="accountSummaryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title">
                    <i class="fas fa-chart-bar me-2"></i>Account Summary
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card bg-primary bg-opacity-10 border-primary">
                            <div class="card-body text-center">
                                <i class="fas fa-wallet fa-2x text-primary mb-2"></i>
                                <h6 class="text-primary">Total Balance</h6>
                                <h4 class="text-light">
                                    ₹{{ "{:,.2f}"|format(data.limits.Net|float) if data.limits and data.limits.Net else '0.00' }}
                                </h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-success bg-opacity-10 border-success">
                            <div class="card-body text-center">
                                <i class="fas fa-arrow-up fa-2x text-success mb-2"></i>
                                <h6 class="text-success">Total P&L</h6>
                                <h4 class="text-light portfolio-pnl">₹{{ "%.2f"|format(data.positions|sum(attribute='pnl')|float if data.positions else 0.0) }}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-warning bg-opacity-10 border-warning">
                            <div class="card-body text-center">
                                <i class="fas fa-chart-pie fa-2x text-warning mb-2"></i>
                                <h6 class="text-warning">Portfolio Value</h6>
                                <h4 class="text-light portfolio-investment">₹{{ "%.2f"|format((data.holdings|sum(attribute='quantity')|float * data.holdings|sum(attribute='avgPrice')|float) if data.holdings else 0.0) }}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-info bg-opacity-10 border-info">
                            <div class="card-body text-center">
                                <i class="fas fa-percentage fa-2x text-info mb-2"></i>
                                <h6 class="text-info">Day's Change</h6>
                                <h4 class="text-light portfolio-change">0.00%</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-danger bg-opacity-10 border-danger">
                            <div class="card-body text-center">
                                <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
                                <h6 class="text-danger">Margin Used</h6>
                                <h4 class="text-light">
                                    ₹{{ "{:,.2f}"|format(data.limits.MarginUsed|float) if data.limits and data.limits.MarginUsed else '0.00' }}
                                </h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-primary bg-opacity-10 border-primary">
                            <div class="card-body text-center">
                                <i class="fas fa-shield-alt fa-2x text-primary mb-2"></i>
                                <h6 class="text-primary">Collateral</h6>
                                <h4 class="text-light">
                                    ₹{{ "{:,.2f}"|format(data.limits.CollateralValue|float) if data.limits and data.limits.CollateralValue else '0.00' }}
                                </h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-primary bg-opacity-10 border-primary">
                            <div class="card-body text-center">
                                <i class="fas fa-refresh fa-2x text-primary mb-2"></i>
                                <h6 class="text-primary">Last Updated</h6>
                                <small class="text-light" id="portfolioLastUpdate">Loading...</small>
                                <br><button class="btn btn-sm btn-primary mt-2" onclick="window.tradingDashboard.refreshPortfolioDetails()">
                                    <i class="fas fa-sync"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Data Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-briefcase me-2"></i>Portfolio Details
                        </h5>
                    </div>
                </div>

                <!-- Raw Portfolio Data Display -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card bg-secondary">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Portfolio Summary Data</h6>
                                <button class="btn btn-sm btn-primary" onclick="refreshPortfolioData()">
                                    <i class="fas fa-sync me-1"></i>Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="portfolioDataDisplay">
                                    <div class="text-center py-3">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Loading portfolio data...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Positions Table -->
                <div class="table-responsive mt-4">
                    <table class="table table-dark table-hover" id="portfolioPositions">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Exchange</th>
                                <th>Product</th>
                                <th class="text-center">Buy Qty</th>
                                <th class="text-center">Sell Qty</th>
                                <th class="text-center">Net Qty</th>
                                <th>Buy Amount</th>
                                <th>Sell Amount</th>
                                <th>P&L</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="positionsTableBody">
                            <tr>
                                <td colspan="10" class="text-center py-3">
                                    <i class="fas fa-spinner fa-spin me-2"></i>Loading positions...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Holdings Table -->
                <div class="table-responsive mt-4">
                    <table class="table table-dark table-hover" id="portfolioHoldings">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Exchange</th>
                                <th class="text-center">Quantity</th>
                                <th>Avg Price</th>
                                <th>LTP</th>
                                <th>Market Value</th>
                                <th>P&L</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="holdingsTableBody">
                            {% if data.holdings %}
                                {% if data.holdings is mapping and data.holdings.get('error') %}
                                <tr><td colspan="8" class="text-center text-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    {{ data.holdings.error }}
                                    <br><small>Please refresh your tokens using the token refresh tool</small>
                                </td></tr>
                                {% elif data.holdings is iterable and data.holdings is not string %}
                                    {% for holding in data.holdings %}
                                    {% if holding is mapping %}
                                    <tr>
                                        <td>
                                            <strong>{{ holding.trdSym or holding.sym or holding.get('tradingSymbol', 'N/A') }}</strong>
                                            <br><small class="text-muted">{{ holding.series or holding.get('series', '') }}</small>
                                        </td>
                                        <td><span class="badge bg-info">{{ holding.exSeg or holding.get('exchange', 'N/A') }}</span></td>
                                        <td class="text-center">{{ holding.quantity or holding.get('qty', 0) }}</td>
                                        <td class="text-end">₹{{ "%.2f"|format(holding.avgPrice or holding.get('averagePrice', 0) or 0) }}</td>
                                        <td class="text-end">₹{{ "%.2f"|format(holding.ltp or holding.get('lastPrice', 0) or holding.get('marketPrice', 0) or 0) }}</td>
                                        <td class="text-end">
                                            {% set qty = holding.quantity or holding.get('qty', 0) or 0 %}
                                            {% set ltp = holding.ltp or holding.get('lastPrice', 0) or holding.get('marketPrice', 0) or 0 %}
                                            ₹{{ "%.2f"|format(qty * ltp) }}
                                        </td>
                                        <td class="text-end">
                                            {% set qty = holding.quantity or holding.get('qty', 0) or 0 %}
                                            {% set ltp = holding.ltp or holding.get('lastPrice', 0) or holding.get('marketPrice', 0) or 0 %}
                                            {% set avg_price = holding.avgPrice or holding.get('averagePrice', 0) or 0 %}
                                            {% set market_value = qty * ltp %}
                                            {% set invested_value = qty * avg_price %}
                                            {% set pnl = market_value - invested_value %}
                                            <span class="{{ 'text-success' if pnl >= 0 else 'text-danger' }}">
                                            ₹{{ "%.2f"|format(pnl) }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge {{ 'bg-success' if holding.get('sqrFlg') == 'Y' or holding.get('status') == 'Active' else 'bg-warning' }}">
                                            {{ 'Active' if holding.get('sqrFlg') == 'Y' or holding.get('status') == 'Active' else 'Inactive' }}
                                        </span>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                                {% else %}
                                    <tr><td colspan="8" class="text-center text-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Invalid holdings data format
                                    </td></tr>
                                {% endif %}
                            {% else %}
                                <tr><td colspan="8" class="text-center py-3">
                                    <i class="fas fa-exclamation-triangle me-2"></i>No holdings found
                                </td></tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                <!-- Limits Information -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card bg-secondary">
                            <div class="card-header">
                                <h6 class="mb-0">Account Limits</h6>
                            </div>
                            <div class="card-body">
                                <div id="limitsDisplay">
                                    <div class="text-center py-3">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Loading limits data...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success">
                    <i class="fas fa-save me-1"></i>Save Settings
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Place Order Modal -->
<div class="modal fade" id="placeOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Place Order
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="placeOrderForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Trading Symbol</label>
                            <input type="text" class="form-control bg-secondary text-light" name="trading_symbol" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Transaction Type</label>
                            <select class="form-select bg-secondary text-light" name="transaction_type" required>
                                <option value="BUY">BUY</option>
                                <option value="SELL">SELL</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control bg-secondary text-light" name="quantity" min="1" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Order Type</label>
                            <select class="form-select bg-secondary text-light" name="order_type" required>
                                <option value="MARKET">MARKET</option>
                                <option value="LIMIT">LIMIT</option>
                                <option value="SL">STOP LOSS</option>
                                <option value="SL-M">SL-MARKET</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Price</label>
                            <input type="number" class="form-control bg-secondary text-light" name="price" step="0.01">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Product</label>
                            <select class="form-select bg-secondary text-light" name="product" required>
                                <option value="CNC">CNC</option>
                                <option value="MIS">MIS</option>
                                <option value="NRML">NRML</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitOrder()">
                    <i class="fas fa-check me-1"></i>Place Order
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Square Off Modal -->
<div class="modal fade" id="squareOffModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title">
                    <i class="fas fa-times me-2 text-danger"></i>Square Off Position
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Are you sure you want to square off this position?
                </div>
                <form id="squareOffForm">
                    <input type="hidden" name="symbol" id="squareOffSymbol">
                    <input type="hidden" name="token" id="squareOffToken">
                    <input type="hidden" name="exchange" id="squareOffExchange">
                    <input type="hidden" name="product" id="squareOffProduct">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Symbol</label>
                            <input type="text" class="form-control bg-secondary text-light" id="squareOffSymbolDisplay" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Quantity to Square Off</label>
                            <input type="number" class="form-control bg-secondary text-light" name="quantity" id="squareOffQuantity" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Order Type</label>
                            <select class="form-select bg-secondary text-light" name="order_type" required>
                                <option value="MARKET">MARKET</option>
                                <option value="LIMIT">LIMIT</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Price (for LIMIT orders)</label>
                            <input type="number" class="form-control bg-secondary text-light" name="price" step="0.01">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitSquareOff()">
                    <i class="fas fa-times me-1"></i>Square Off
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Position Details Modal -->
<div class="modal fade" id="positionDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2 text-info"></i>Position Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="positionDetailsContent">
                    <!-- Position details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Order Management Modal -->
<div class="modal fade" id="orderManagementModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2 text-warning"></i>Manage Orders
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="orderManagementContent">
                    <!-- Order management content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dashboard-specific JavaScript functions
function openPlaceOrderModal(type = 'BUY', symbol = '', token = '', exchange = '') {
    const modal = document.getElementById('placeOrderModal');
    if (modal) {
        const transactionSelect = modal.querySelector('select[name="transaction_type"]');
        const symbolInput = modal.querySelector('input[name="trading_symbol"]');
        
        if (transactionSelect) transactionSelect.value = type;
        if (symbolInput && symbol) symbolInput.value = symbol;
        
        // Store additional data for API calls
        if (token) modal.dataset.token = token;
        if (exchange) modal.dataset.exchange = exchange;

        new bootstrap.Modal(modal).show();
    }
}

function openSquareOffModal(symbol, quantity, token, exchange, product) {
    const modal = document.getElementById('squareOffModal');
    if (modal) {
        document.getElementById('squareOffSymbol').value = symbol;
        document.getElementById('squareOffSymbolDisplay').value = symbol;
        document.getElementById('squareOffQuantity').value = Math.abs(quantity);
        document.getElementById('squareOffToken').value = token;
        document.getElementById('squareOffExchange').value = exchange;
        document.getElementById('squareOffProduct').value = product;
        
        new bootstrap.Modal(modal).show();
    }
}

function showPositionDetails(symbol, positionData) {
    const modal = document.getElementById('positionDetailsModal');
    const content = document.getElementById('positionDetailsContent');
    
    if (modal && content) {
        const netQty = (positionData.flBuyQty || 0) - (positionData.flSellQty || 0);
        const avgPrice = netQty !== 0 ? ((positionData.buyAmt || 0) - (positionData.sellAmt || 0)) / netQty : 0;
        const currentPrice = positionData.ltp || positionData.stkPrc || 0;
        const currentValue = currentPrice * netQty;
        const pnl = currentValue - (avgPrice * netQty);
        const pnlPercent = avgPrice !== 0 && netQty !== 0 ? (pnl / (avgPrice * netQty) * 100) : 0;
        
        content.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <div class="card bg-secondary mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-tag me-2"></i>Basic Information</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-dark table-sm">
                                <tr><td>Symbol:</td><td class="text-primary fw-bold">${symbol}</td></tr>
                                <tr><td>Exchange:</td><td>${positionData.exSeg || 'NSE'}</td></tr>
                                <tr><td>Product:</td><td>${positionData.prod || 'CNC'}</td></tr>
                                <tr><td>Token:</td><td>${positionData.tok || 'N/A'}</td></tr>
                                <tr><td>Series:</td><td>${positionData.series || 'EQ'}</td></tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card bg-secondary mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Position Summary</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-dark table-sm">
                                <tr><td>Net Quantity:</td><td class="fw-bold ${netQty > 0 ? 'text-success' : netQty < 0 ? 'text-danger' : 'text-muted'}">${netQty}</td></tr>
                                <tr><td>Average Price:</td><td class="fw-bold">₹${avgPrice.toFixed(2)}</td></tr>
                                <tr><td>Current Price:</td><td class="fw-bold text-warning">₹${currentPrice.toFixed(2)}</td></tr>
                                <tr><td>Current Value:</td><td class="fw-bold">₹${currentValue.toFixed(2)}</td></tr>
                                <tr><td>P&L:</td><td class="fw-bold ${pnl > 0 ? 'text-success' : pnl < 0 ? 'text-danger' : 'text-muted'}">${pnl > 0 ? '+' : ''}₹${pnl.toFixed(2)} (${pnlPercent > 0 ? '+' : ''}${pnlPercent.toFixed(2)}%)</td></tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="card bg-secondary">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-arrow-up me-2 text-success"></i>Buy Details</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-dark table-sm">
                                <tr><td>Buy Quantity:</td><td class="text-success fw-bold">${positionData.flBuyQty || 0}</td></tr>
                                <tr><td>Buy Amount:</td><td class="text-success">₹${(positionData.buyAmt || 0).toFixed(2)}</td></tr>
                                <tr><td>CF Buy Quantity:</td><td>${positionData.cfBuyQty || 0}</td></tr>
                                <tr><td>CF Buy Amount:</td><td>₹${(positionData.cfBuyAmt || 0).toFixed(2)}</td></tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card bg-secondary">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-arrow-down me-2 text-danger"></i>Sell Details</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-dark table-sm">
                                <tr><td>Sell Quantity:</td><td class="text-danger fw-bold">${positionData.flSellQty || 0}</td></tr>
                                <tr><td>Sell Amount:</td><td class="text-danger">₹${(positionData.sellAmt || 0).toFixed(2)}</td></tr>
                                <tr><td>CF Sell Quantity:</td><td>${positionData.cfSellQty || 0}</td></tr>
                                <tr><td>CF Sell Amount:</td><td>₹${(positionData.cfSellAmt || 0).toFixed(2)}</td></tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        new bootstrap.Modal(modal).show();
    }
}

function submitOrder() {
    const form = document.getElementById('placeOrderForm');
    const formData = new FormData(form);
    const orderData = Object.fromEntries(formData.entries());
    
    // Add token and exchange if available
    const modal = document.getElementById('placeOrderModal');
    if (modal.dataset.token) orderData.token = modal.dataset.token;
    if (modal.dataset.exchange) orderData.exchange = modal.dataset.exchange;

    fetch('/api/place_order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(orderData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Order placed successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('placeOrderModal')).hide();
            if (window.realTimeDashboard) {
                window.realTimeDashboard.refreshData();
            }
        } else {
            showNotification('Error placing order: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error placing order: ' + error.message, 'error');
    });
}

function submitSquareOff() {
    const form = document.getElementById('squareOffForm');
    const formData = new FormData(form);
    const orderData = Object.fromEntries(formData.entries());
    
    // Set transaction type to SELL for square off
    orderData.transaction_type = 'SELL';
    orderData.trading_symbol = orderData.symbol;

    fetch('/api/place_order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(orderData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Position squared off successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('squareOffModal')).hide();
            if (window.realTimeDashboard) {
                window.realTimeDashboard.refreshData();
            }
        } else {
            showNotification('Error squaring off position: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error squaring off position: ' + error.message, 'error');
    });
}

function showOrderManagement(symbol) {
    const modal = document.getElementById('orderManagementModal');
    const content = document.getElementById('orderManagementContent');
    
    if (modal && content) {
        content.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin me-2"></i>Loading orders...</div>';
        
        fetch(`/api/orders?symbol=${encodeURIComponent(symbol)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.orders) {
                const pendingOrders = data.orders.filter(order => 
                    ['pending', 'open', 'trigger_pending'].includes(order.ordSt) && 
                    order.trdSym === symbol
                );
                
                if (pendingOrders.length > 0) {
                    content.innerHTML = `
                        <h6 class="mb-3">Pending Orders for ${symbol}</h6>
                        <div class="table-responsive">
                            <table class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Type</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pendingOrders.map(order => `
                                        <tr>
                                            <td>${order.nOrdNo || 'N/A'}</td>
                                            <td><span class="badge ${order.tranType === 'BUY' ? 'bg-success' : 'bg-danger'}">${order.tranType}</span></td>
                                            <td>${order.qty || 0}</td>
                                            <td>₹${(order.prc || 0).toFixed(2)}</td>
                                            <td><span class="badge bg-warning">${order.ordSt}</span></td>
                                            <td>
                                                <button class="btn btn-sm btn-warning me-1" onclick="modifyOrder('${order.nOrdNo}')">
                                                    <i class="fas fa-edit"></i> Modify
                                                </button>
                                                <button class="btn btn-sm btn-danger" onclick="cancelOrder('${order.nOrdNo}')">
                                                    <i class="fas fa-times"></i> Cancel
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <h5>No Pending Orders</h5>
                            <p>All orders for ${symbol} have been executed or cancelled.</p>
                        </div>
                    `;
                }
            } else {
                content.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <h5>Error Loading Orders</h5>
                        <p>${data.error || 'Failed to load orders'}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            content.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                    <h5>Network Error</h5>
                    <p>Failed to load orders: ${error.message}</p>
                </div>
            `;
        });
        
        new bootstrap.Modal(modal).show();
    }
}

function cancelOrder(orderId) {
    if (!confirm('Are you sure you want to cancel this order?')) return;
    
    fetch('/api/cancel_order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ order_id: orderId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Order cancelled successfully!', 'success');
            // Refresh the order management modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('orderManagementModal'));
            if (modal) {
                modal.hide();
            }
            if (window.realTimeDashboard) {
                window.realTimeDashboard.refreshData();
            }
        } else {
            showNotification('Error cancelling order: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error cancelling order: ' + error.message, 'error');
    });
}

function modifyOrder(orderId) {
    // For now, just show a message that modify functionality is coming soon
    showNotification('Order modification feature coming soon!', 'info');
}

function showNotification(message, type = 'info') {
    const alertClass = type === 'success' ? 'alert-success' : 
                     type === 'error' ? 'alert-danger' : 
                     type === 'warning' ? 'alert-warning' : 'alert-info';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} position-fixed shadow-lg`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 350px; max-width: 400px;';
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="flex-grow-1">${message}</div>
            <button type="button" class="btn-close" onclick="this.closest('.alert').remove()"></button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.opacity = '0';
            notification.style.transition = 'opacity 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }
    }, 5000);
}

function refreshDashboard() {
    if (window.realTimeDashboard) {
        window.realTimeDashboard.manualRefresh();
    } else {
        window.location.reload();
    }
}

// Event listeners for position management buttons
document.addEventListener('DOMContentLoaded', function() {
    // Place order buttons
    document.addEventListener('click', function(e) {
        if (e.target.closest('.place-order-btn')) {
            const btn = e.target.closest('.place-order-btn');
            const type = btn.dataset.type;
            const symbol = btn.dataset.symbol;
            const token = btn.dataset.token;
            const exchange = btn.dataset.exchange;
            openPlaceOrderModal(type, symbol, token, exchange);
        }
        
        // Square off buttons
        if (e.target.closest('.square-off-btn')) {
            const btn = e.target.closest('.square-off-btn');
            const symbol = btn.dataset.symbol;
            const quantity = btn.dataset.quantity;
            const token = btn.dataset.token;
            const exchange = btn.dataset.exchange;
            const product = btn.dataset.product;
            openSquareOffModal(symbol, quantity, token, exchange, product);
        }
        
        // Position details buttons
        if (e.target.closest('.position-details-btn')) {
            const btn = e.target.closest('.position-details-btn');
            const symbol = btn.dataset.symbol;
            const positionData = JSON.parse(btn.dataset.position);
            showPositionDetails(symbol, positionData);
        }
    });
});

async function refreshQuotes() {
    const button = document.querySelector('[onclick="refreshQuotes()"]');
    if (button) {
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
        button.disabled = true;
    }

    try {
        // Fetch fresh quote data from server
        const response = await fetch('/api/live_quotes');
        const data = await response.json();

        if (data.success) {
            // Update quotes table with real data
            const quotesTableBody = document.getElementById('quotesTableBody');
            if (quotesTableBody && data.quotes) {
                data.quotes.forEach(quote => {
                    const row = document.querySelector(`tr[data-symbol="${quote.symbol}"]`);
                    if (row) {
                        const ltpCell = row.querySelector('.price-ltp');
                        const changeCell = row.querySelector('.price-change');
                        const changePctCell = row.cells[3];
                        const timeCell = row.querySelector('small');

                        if (ltpCell) {
                            const oldPrice = parseFloat(ltpCell.textContent.replace(/[₹,]/g, ''));
                            const newPrice = parseFloat(quote.ltp);

                            ltpCell.textContent = `₹${newPrice.toFixed(2)}`;

                            // Add animation based on price change
                            if (newPrice > oldPrice) {
                                ltpCell.classList.add('price-up');
                            } else if (newPrice < oldPrice) {
                                ltpCell.classList.add('price-down');
                            }

                            setTimeout(() => {
                                ltpCell.classList.remove('price-up', 'price-down');
                            }, 1000);
                        }

                        if (changeCell && quote.change !== undefined) {
                            changeCell.textContent = `${quote.change >= 0 ? '+' : ''}${parseFloat(quote.change).toFixed(2)}`;
                            changeCell.className = `price-change ${quote.change >= 0 ? 'text-success' : 'text-danger'}`;
                        }

                        if (changePctCell && quote.changePct !== undefined) {
                            changePctCell.textContent = `${quote.changePct >= 0 ? '+' : ''}${parseFloat(quote.changePct).toFixed(2)}%`;
                            changePctCell.className = quote.changePct >= 0 ? 'text-success' : 'text-danger';
                        }

                        if (timeCell) {
                            timeCell.textContent = new Date().toLocaleTimeString();
                        }
                    }
                });
            }
        } else {
            // Fallback to simulated updates if API fails
            simulateQuoteUpdates();
        }
    } catch (error) {
        console.error('Error refreshing quotes:', error);
        // Fallback to simulated updates
        simulateQuoteUpdates();
    }

    if (button) {
        button.innerHTML = '<i class="fas fa-sync me-1"></i>Refresh';
        button.disabled = false;
    }
}

function simulateQuoteUpdates() {
    const quotes = document.querySelectorAll('#quotesTable .price-ltp');
    quotes.forEach(quote => {
        const currentPrice = parseFloat(quote.textContent.replace(/[₹,]/g, ''));
        const change = (Math.random() - 0.5) * 20;
        const newPrice = currentPrice + change;

        quote.textContent = `₹${newPrice.toFixed(2)}`;

        const row = quote.closest('tr');
        const changeCell = row.querySelector('.price-change');
        const changePctCell = row.cells[3];

        if (changeCell && changePctCell) {
            const changePercent = (change / currentPrice * 100);
            changeCell.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}`;
            changeCell.className = `price-change ${change >= 0 ? 'text-success' : 'text-danger'}`;

            changePctCell.textContent = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
            changePctCell.className = change >= 0 ? 'text-success' : 'text-danger';
        }

        quote.classList.add(change >= 0 ? 'price-up' : 'price-down');
        setTimeout(() => {
            quote.classList.remove('price-up', 'price-down');
        }, 1000);
    });
}

async function refreshPositions() {
    const button = document.querySelector('[onclick="refreshPositions()"]');
    if (button) {
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
        button.disabled = true;
    }

    try {
        const response = await fetch('/api/positions');
        const data = await response.json();

        if (data.success && data.positions) {
            const positionsTableBody = document.getElementById('positionsTableBody');
            if (positionsTableBody) {
                // Update positions with fresh data
                data.positions.forEach(position => {
                    const row = document.querySelector(`tr[data-position-symbol="${position.trdSym || position.sym}"]`);
                    if (row) {
                        const ltpCell = row.querySelector('.price-ltp');
                        const pnlCell = row.querySelector('.position-pnl');

                        if (ltpCell && position.ltp) {
                            const oldPrice = parseFloat(ltpCell.textContent.replace(/[₹,]/g, ''));
                            const newPrice = parseFloat(position.ltp);

                            ltpCell.textContent = `₹${newPrice.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;

                            if (newPrice !== oldPrice) {
                                ltpCell.classList.add(newPrice > oldPrice ? 'price-up' : 'price-down');
                                setTimeout(() => {
                                    ltpCell.classList.remove('price-up', 'price-down');
                                }, 1000);
                            }
                        }

                        if (pnlCell && position.pnl !== undefined) {
                            const pnl = parseFloat(position.pnl);
                            pnlCell.innerHTML = `<span class="fw-bold ${pnl > 0 ? 'text-success' : pnl < 0 ? 'text-danger' : 'text-muted'}">₹${pnl.toFixed(2)}</span>`;
                        }
                    }
                });

                console.log('Positions refreshed successfully');
            }
        }
    } catch (error) {
        console.error('Error refreshing positions:', error);
        // Fallback to simulated updates
        simulatePositionUpdates();
    }

    if (button) {
        button.innerHTML = '<i class="fas fa-sync me-1"></i>Refresh';
        button.disabled = false;
    }
}

function simulatePositionUpdates() {
    const positions = document.querySelectorAll('#positionsTable .price-ltp');
    positions.forEach(position => {
        const currentPrice = parseFloat(position.textContent.replace(/[₹,]/g, ''));
        const change = (Math.random() - 0.5) * 10;
        const newPrice = currentPrice + change;

        position.textContent = `₹${newPrice.toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
        position.classList.add(change >= 0 ? 'price-up' : 'price-down');
        setTimeout(() => {
            position.classList.remove('price-up', 'price-down');
        }, 1000);
    });
}

// User Profile Functions
function showUserProfile() {
    // Set login time if not already set
    const loginTimeElement = document.getElementById('loginTime');
    if (loginTimeElement && loginTimeElement.textContent === 'N/A') {
        const now = new Date();
        loginTimeElement.textContent = now.toLocaleString();
    }

    new bootstrap.Modal(document.getElementById('userProfileModal')).show();
}

function showAccountSummary() {
    // Close user profile modal if open
    const userProfileModal = bootstrap.Modal.getInstance(document.getElementById('userProfileModal'));
    if (userProfileModal) {
        userProfileModal.hide();
    }

    // Show account summary modal
    new bootstrap.Modal(document.getElementById('accountSummaryModal')).show();
}

async function refreshPortfolioSummary() {
    try {
        const response = await fetch('/api/portfolio_summary');
        const data = await response.json();

        if (data.success) {
            // Update portfolio summary cards
            const totalPositionsEl = document.getElementById('totalPositions');
            const totalHoldingsEl = document.getElementById('totalHoldings');
            const totalOrdersEl = document.getElementById('totalOrders');
            const availableMarginEl = document.getElementById('availableMargin');

            if (totalPositionsEl && data.total_positions !== undefined) {
                totalPositionsEl.textContent = data.total_positions;
            }
            if (totalHoldingsEl && data.total_holdings !== undefined) {
                totalHoldingsEl.textContent = data.total_holdings;
            }
            if (totalOrdersEl && data.total_orders !== undefined) {
                totalOrdersEl.textContent = data.total_orders;
            }
            if (availableMarginEl && data.available_margin !== undefined) {
                availableMarginEl.textContent = `₹${parseFloat(data.available_margin).toLocaleString('en-IN', {minimumFractionDigits: 2})}`;
            }
        }
    } catch (error) {
        console.error('Error refreshing portfolio summary:', error);
    }
}

// Add function to refresh portfolio data
function refreshPortfolioData() {
    if (window.tradingDashboard) {
        window.tradingDashboard.refreshPortfolioDetails();
    }
}

// Set last login time on page load and load user profile
document.addEventListener('DOMContentLoaded', function() {
    const lastLoginElement = document.getElementById('lastLoginTime');
    if (lastLoginElement) {
        const now = new Date();
        lastLoginElement.textContent = now.toLocaleDateString() + ' at ' + now.toLocaleTimeString();
    }

    // Set portfolio last update time
    const portfolioUpdateElement = document.getElementById('portfolioLastUpdate');
    if (portfolioUpdateElement) {
        const now = new Date();
        portfolioUpdateElement.textContent = now.toLocaleTimeString();
    }

    // Load user profile data
    loadUserProfile();
});

// Function to load user profile data
async function loadUserProfile() {
    try {
        const response = await fetch('/api/user_profile');
        const data = await response.json();

        if (data.success && data.profile) {
            const profile = data.profile;

            // Update login time if available
            const loginTimeElement = document.getElementById('loginTime');
            if (loginTimeElement && profile.login_time !== 'N/A') {
                loginTimeElement.textContent = profile.login_time;
            }

            console.log('User profile loaded:', profile);
        }
    } catch (error) {
        console.error('Error loading user profile:', error);
    }
}

// Auto-refresh specific sections every 15 seconds instead of full page
setInterval(() => {
    refreshQuotes();
    refreshPositions();
    refreshPortfolioSummary();
}, 15000);



// Update user profile section
        async function updateUserProfile() {
            try {
                const response = await fetch('/api/user_profile');
                const data = await response.json();

                if (data.success && data.profile) {
                    const profile = data.profile;

                    // Update profile information
                    document.getElementById('userUCC').textContent = profile.ucc;
                    document.getElementById('userGreeting').textContent = profile.greeting_name;
                    document.getElementById('loginTime').textContent = profile.login_time;

                    // Show truncated tokens for security
                    document.getElementById('accessTokenDisplay').value = profile.access_token;
                    document.getElementById('sessionTokenDisplay').value = profile.session_token;
                    document.getElementById('sidDisplay').value = profile.sid;

                    // Update token status
                    const tokenStatusText = document.getElementById('tokenStatusText');
                    const refreshTokenBtn = document.getElementById('refreshTokenBtn');
                    const authWarning = document.getElementById('authWarning');

                    if (profile.token_status === 'Valid') {
                        tokenStatusText.textContent = 'Valid';
                        tokenStatusText.className = 'text-success';
                        refreshTokenBtn.style.display = 'none';
                        authWarning.style.display = 'none';
                    } else if (profile.token_status === 'Expired') {
                        tokenStatusText.textContent = 'Expired';
                        tokenStatusText.className = 'text-danger';
                        refreshTokenBtn.style.display = 'block';
                        authWarning.style.display = 'block';
                        refreshTokenBtn.onclick = () => window.location.href = '/login';
                    } else {
                        tokenStatusText.textContent = 'Invalid';
                        tokenStatusText.className = 'text-warning';
                        refreshTokenBtn.style.display = 'block';
                        authWarning.style.display = 'block';
                        refreshTokenBtn.onclick = () => window.location.href = '/login';
                    }
                }
            } catch (error) {
                console.error('Error updating user profile:', error);
                // Show error state
                const tokenStatusText = document.getElementById('tokenStatusText');
                tokenStatusText.textContent = 'Error';
                tokenStatusText.className = 'text-danger';
            }
        }

// Order Management Functions
function showOrderManagement(symbol) {
    fetch(`/api/orders?symbol=${symbol}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.orders.length > 0) {
                showOrderModal(data.orders);
            } else {
                alert('No pending orders found for ' + symbol);
            }
        })
        .catch(error => {
            console.error('Error fetching orders:', error);
            alert('Error fetching orders');
        });
}

function showOrderModal(orders) {
    let modalContent = `
        <div class="modal fade" id="orderManagementModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content bg-dark">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Manage Orders</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Type</th>
                                        <th>Qty</th>
                                        <th>Price</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>`;
    
    orders.forEach(order => {
        modalContent += `
            <tr>
                <td><strong>${order.trdSym || order.sym}</strong></td>
                <td><span class="badge ${order.trnsTp === 'BUY' ? 'bg-success' : 'bg-danger'}">${order.trnsTp}</span></td>
                <td>${order.qty}</td>
                <td>₹${order.prc || 'Market'}</td>
                <td><span class="badge bg-warning">${order.ordSt}</span></td>
                <td>
                    <button class="btn btn-xs btn-primary me-1" onclick="modifyOrder('${order.nOrdNo}', '${order.trdSym}', ${order.qty}, ${order.prc || 0})">
                        <i class="fas fa-edit"></i> Modify
                    </button>
                    <button class="btn btn-xs btn-danger" onclick="cancelOrder('${order.nOrdNo}')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </td>
            </tr>`;
    });
    
    modalContent += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>`;
    
    const existingModal = document.getElementById('orderManagementModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalContent);
    new bootstrap.Modal(document.getElementById('orderManagementModal')).show();
}

function modifyOrder(orderNo, symbol, currentQty, currentPrice) {
    const newQty = prompt(`Modify quantity for ${symbol}:`, currentQty);
    const newPrice = prompt(`Modify price for ${symbol}:`, currentPrice);
    
    if (newQty && newPrice) {
        const modifyData = {
            order_no: orderNo,
            quantity: parseInt(newQty),
            price: parseFloat(newPrice)
        };
        
        fetch('/api/modify_order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(modifyData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Order modified successfully!');
                bootstrap.Modal.getInstance(document.getElementById('orderManagementModal')).hide();
                refreshDashboard();
            } else {
                alert('Failed to modify order: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error modifying order');
        });
    }
}

function cancelOrder(orderNo) {
    if (confirm('Are you sure you want to cancel this order?')) {
        fetch('/api/cancel_order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ order_no: orderNo })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Order cancelled successfully!');
                bootstrap.Modal.getInstance(document.getElementById('orderManagementModal')).hide();
                refreshDashboard();
            } else {
                alert('Failed to cancel order: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error cancelling order');
        });
    }
}
</script>
{% endblock %}